- id: alaina_wake_echo_alarm
  alias: "Alaina - Wake With Echo Alarm"
  description: "Gradual sunrise fade starting 10 min before Echo alarm"
  trigger:
    - platform: time_pattern
      minutes: "/1"
  condition:
    - condition: state
      entity_id: person.alaina_spencer
      state: "home"
    - condition: template
      value_template: >
        {% set alarm = states('sensor.alaina_s_bedroom_echo_show_next_alarm_2') %}
        {% if alarm not in ['unknown', 'unavailable', 'None', ''] %}
          {% set alarm_time = as_datetime(alarm).astimezone(now().tzinfo) %}
          {% set diff = (alarm_time - now()).total_seconds() / 60 %}
          {{ 9 <= diff <= 10 }}
        {% else %}
          false
        {% endif %}
  action:
    - service: script.alaina_gradual_wake
  mode: single

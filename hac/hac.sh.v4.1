#!/bin/bash

# HAC v4.1 - Home Assistant Command-line Interface
# Usage: hac [command] [options]

VERSION="4.1"
CONTEXTS_DIR="/config/hac/contexts"
LEARNINGS_DIR="/config/hac/learnings"
TEMPLATES_DIR="/config/hac/templates"

mkdir -p "$CONTEXTS_DIR" "$LEARNINGS_DIR" "$TEMPLATES_DIR"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Helper function to get entity list
get_entities() {
    grep '"entity_id"' /config/.storage/core.entity_registry | grep -o '"entity_id":"[^"]*"' | cut -d'"' -f4 | sort
}

# Helper function to filter entities by pattern
filter_entities() {
    get_entities | grep -i "$1"
}

show_help() {
    echo -e "${CYAN}HAC v${VERSION} - Home Assistant AI Context Manager${NC}"
    echo ""
    echo "Usage: hac [command] [options]"
    echo ""
    echo -e "${YELLOW}Commands:${NC}"
    echo "  c, claude          Generate Claude context (full system)"
    echo "  g, gemini          Generate Gemini context (quick query)"
    echo "  gpt, chatgpt       Generate ChatGPT context (specific area)"
    echo "  a, auto            Automation recovery context"
    echo "  t, tablet          Tablet-specific context"
    echo "  d, debug           Device troubleshooting context"
    echo ""
    echo "  learn              Learn kitchen tablet project"
    echo "  list, ls           List recent contexts"
    echo "  search [term]      Search for entities"
    echo "  check              Quick system check"
    echo ""
    echo "  help, -h, --help   Show this help"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  hac c              # Generate Claude context"
    echo "  hac tablet         # Generate tablet context"
    echo "  hac search kitchen # Search for kitchen entities"
}

generate_claude_context() {
    echo -e "${BLUE}Generating Claude context...${NC}"
    CONTEXT_FILE="$CONTEXTS_DIR/claude_$(date +%Y%m%d_%H%M%S).md"
    
    {
        echo "# Home Assistant System Context for Claude"
        echo "Generated: $(date)"
        echo "Location: 40154 US Highway 53, Strum, Wisconsin"
        echo ""
        echo "## System Info"
        ha core info
        echo ""
        echo "## Automations"
        echo "Count: $(ha automation list | wc -l)"
        echo ""
        echo "## Entity Summary by Domain"
        get_entities | awk -F'.' '{print $1}' | sort | uniq -c | sort -rn
        echo ""
        echo "## Tablet Entities"
        filter_entities "tablet"
        echo ""
        echo "## Climate Entities"
        filter_entities "^climate\."
        echo ""
        echo "## Person Entities"
        filter_entities "^person\."
        echo ""
        echo "## Recent Errors"
        ha core logs | grep -i error | tail -20
    } > "$CONTEXT_FILE"
    
    echo -e "${GREEN}✓ Context saved: $CONTEXT_FILE${NC}"
    echo "View with: cat $CONTEXT_FILE"
}

generate_tablet_context() {
    echo -e "${BLUE}Generating tablet context...${NC}"
    CONTEXT_FILE="$CONTEXTS_DIR/tablet_$(date +%Y%m%d_%H%M%S).md"
    
    {
        echo "# Kitchen Tablet Context"
        echo "Generated: $(date)"
        echo "Hardware: Samsung Galaxy Tab A9 (SM-X210)"
        echo ""
        echo "## All Tablet Entities"
        filter_entities "tablet"
        echo ""
        echo "## Fully Kiosk Entities"
        filter_entities "fully"
        echo ""
        echo "## Screen Control Entities"
        filter_entities "screen"
        echo ""
        echo "## Motion Sensor"
        filter_entities "motion" | grep -i tablet
        echo ""
        echo "## Dashboard File"
        if [ -f /config/dashboards/lovelace-kitchen-tablet.yaml ]; then
            echo "File: lovelace-kitchen-tablet.yaml"
            echo "Lines: $(wc -l /config/dashboards/lovelace-kitchen-tablet.yaml | awk '{print $1}')"
        else
            echo "Dashboard not found"
        fi
        echo ""
        echo "## Related Automations"
        grep -i "tablet\|screen" /config/automations.yaml 2>/dev/null | grep "alias:" || echo "No automations found"
    } > "$CONTEXT_FILE"
    
    echo -e "${GREEN}✓ Context saved: $CONTEXT_FILE${NC}"
    echo ""
    echo "Preview:"
    cat "$CONTEXT_FILE"
}

generate_automation_context() {
    echo -e "${BLUE}Generating automation recovery context...${NC}"
    CONTEXT_FILE="$CONTEXTS_DIR/automation_$(date +%Y%m%d_%H%M%S).md"
    
    {
        echo "# Automation Recovery Context"
        echo "Generated: $(date)"
        echo ""
        echo "## Most Recent Backup"
        ls -lt /backup/*.tar 2>/dev/null | head -1
        echo ""
        echo "## automations.yaml"
        if [ -f /config/automations.yaml ]; then
            echo "\`\`\`yaml"
            cat /config/automations.yaml
            echo "\`\`\`"
        else
            echo "File not found"
        fi
        echo ""
        echo "## Automation Entities"
        filter_entities "^automation\."
    } > "$CONTEXT_FILE"
    
    echo -e "${GREEN}✓ Context saved: $CONTEXT_FILE${NC}"
}

learn_project() {
    echo -e "${BLUE}Learning kitchen tablet project...${NC}"
    LOG="$LEARNINGS_DIR/learn_$(date +%Y%m%d_%H%M%S).md"
    
    {
        echo "# Kitchen Tablet Project Learning"
        echo "Date: $(date)"
        echo ""
        echo "## Uploaded Documentation"
        ls -1 /mnt/user-data/uploads/*.md 2>/dev/null || echo "None found"
        echo ""
        echo "## Uploaded Config Files"
        ls -1 /mnt/user-data/uploads/*.yaml 2>/dev/null || echo "None found"
        echo ""
        echo "## Uploaded Scripts"
        ls -1 /mnt/user-data/uploads/*.sh 2>/dev/null || echo "None found"
        echo ""
        echo "## Current Deployment Status"
        echo "Dashboard file exists: $([ -f /config/dashboards/lovelace-kitchen-tablet.yaml ] && echo "YES" || echo "NO")"
        echo "Automations directory: $([ -d /config/automations ] && echo "YES" || echo "NO")"
        echo "Fully Kiosk integration: $(ha integration list | grep -qi fully && echo "YES" || echo "NO")"
        echo ""
        echo "## Tablet Entities Found"
        filter_entities "tablet" | head -10
    } > "$LOG"
    
    cat "$LOG"
    echo ""
    echo -e "${GREEN}✓ Learning log saved: $LOG${NC}"
}

list_contexts() {
    echo -e "${CYAN}Recent Contexts:${NC}"
    echo "════════════════════════════════════════════════════════"
    ls -lth "$CONTEXTS_DIR" 2>/dev/null | head -15 || echo "No contexts yet"
    echo ""
    if [ -d "$LEARNINGS_DIR" ] && [ "$(ls -A $LEARNINGS_DIR 2>/dev/null)" ]; then
        echo -e "${CYAN}Learning Logs:${NC}"
        echo "════════════════════════════════════════════════════════"
        ls -lth "$LEARNINGS_DIR" | head -10
    fi
}

search_entities() {
    if [ -z "$1" ]; then
        read -p "Search term: " term
    else
        term="$1"
    fi
    echo -e "${CYAN}Entities matching '$term':${NC}"
    filter_entities "$term"
}

quick_check() {
    echo -e "${CYAN}═══════════════════════════════════════${NC}"
    echo -e "${GREEN}  Quick System Check${NC}"
    echo -e "${CYAN}═══════════════════════════════════════${NC}"
    echo ""
    echo -e "${YELLOW}Version:${NC}"
    ha core info | grep version
    echo ""
    echo -e "${YELLOW}Disk Space:${NC}"
    df -h /config | tail -1
    echo ""
    echo -e "${YELLOW}Total Entities:${NC} $(get_entities | wc -l)"
    echo ""
    echo -e "${YELLOW}Recent Errors:${NC}"
    ha core logs | grep -i error | tail -3
}

# Main command handler
case "$1" in
    c|claude)
        generate_claude_context
        ;;
    g|gemini)
        echo "Gemini context (optimized for quick queries)"
        generate_claude_context
        ;;
    gpt|chatgpt)
        echo "ChatGPT context (optimized for specific areas)"
        generate_claude_context
        ;;
    a|auto|automation)
        generate_automation_context
        ;;
    t|tablet)
        generate_tablet_context
        ;;
    d|debug)
        echo "Debug context - Coming soon"
        ;;
    learn)
        learn_project
        ;;
    list|ls)
        list_contexts
        ;;
    search)
        search_entities "$2"
        ;;
    check)
        quick_check
        ;;
    help|-h|--help|"")
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run 'hac help' for usage"
        exit 1
        ;;
esac

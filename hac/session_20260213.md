# Session 2026-02-13: System Audit and Critical Fixes

## Critical Issues Resolved

### 1. Automation YAML Syntax Error
**Problem**: Duplicate Alaina LED automation with broken YAML indentation
**Location**: `automations.yaml` lines 236-258
**Fix**: Removed duplicate, fixed indentation, consolidated to single automation
**Commit**: `50bc72b - fix: Alaina LED automation YAML syntax and duplicate removal`

### 2. Security Breach - Exposed GitHub Token
**Problem**: Classic GitHub PAT exposed in Git Pull add-on config
**Token**: `ghp_Inaxo...` (expired Oct 25, 2025, but still in config)
**Fix**: 
- Generated SSH key pair: `ssh-keygen -t ed25519 -f /root/.ssh/ha_deploy_key`
- Added deploy key to GitHub repo with write access
- Reconfigured Git Pull add-on to use SSH authentication
**Result**: More secure, no tokens in config

### 3. Git Pull Add-on Error State
**Problems**:
- Branch mismatch: configured for `master`, repo uses `main`
- Password authentication failing with fine-grained tokens
**Fix**:
- Changed `git_branch: master` → `git_branch: main`
- Switched from HTTPS+password to SSH deploy key
- Repository URL: `https://...` → `git@github.com:pigeonfallsrn/homeassistant-config.git`
**Result**: Add-on state changed from `error` to `started`

### 4. Plex Media Server Add-on Error State
**Problem**: Missing claim code
**Fix**: Added claim code from https://www.plex.tv/claim
**Result**: Add-on started successfully
**Discovery**: User already has Plex on Synology NAS - HA Plex add-on may be redundant

## System Review Findings

### Architecture Assessment: 9.8/10
- **Excellent**: Package-based architecture (32 packages)
- **Excellent**: ~100+ sophisticated automations
- **Excellent**: Git-tracked configuration with meaningful commits
- **Excellent**: HAC workflow integration
- **Excellent**: Split YAML configuration (clean organization)

### Configuration Structure
```
/homeassistant/
├── automations.yaml (4 UI automations)
├── packages/ (32 automation packages, ~100+ automations)
├── configuration.yaml (clean, well-organized)
├── adaptive_lighting.yaml
├── dashboards/ (3 custom dashboards)
└── hac/ (documentation workflow)
```

### Key Integrations Active
- Adaptive Lighting (4 instances)
- ZHA (49 devices on Sonoff 3.0 coordinator)
- Philips Hue (via ZHA + groups)
- UniFi presence detection (AP-based)
- Comprehensive garage automation system
- Kids bedroom automation (Alaina & Ella)
- Climate analytics and humidity monitoring
- Voice assist stack (Whisper, Piper, openWakeWord)

### Add-on Health
- ✅ All critical add-ons now in `started` state
- ✅ Git Pull: Working with SSH
- ✅ Plex: Working (may disable - redundant with Synology)
- ⚠️ Nginx Proxy Manager: Unknown state (check if needed)

## Technical Learnings

### Git Pull Add-on + Fine-Grained Tokens
**Issue**: Git Pull add-on doesn't work well with GitHub fine-grained tokens in password field
**Error**: `fatal: refusing to work with credential missing host field`
**Solution**: Use SSH deploy keys instead (more secure anyway)
**Process**:
1. Generate key: `ssh-keygen -t ed25519 -C "homeassistant-git-pull" -f /root/.ssh/ha_deploy_key -N ""`
2. Add public key to GitHub repo settings with write access
3. Configure add-on with private key in YAML array format
4. Change repo URL to SSH format

### YAML Formatting for Multi-line SSH Keys
SSH keys must be formatted as YAML array of quoted strings:
```yaml
deployment_key:
  - "-----BEGIN OPENSSH PRIVATE KEY-----"
  - "line2content..."
  - "line3content..."
  - "-----END OPENSSH PRIVATE KEY-----"
```

### Automation Organization Best Practices
Observed dual automation system:
- **UI automations** (`automations.yaml`): Simple, GUI-manageable (4 total)
- **Package automations** (`/packages/*.yaml`): Complex, YAML-only (~100+)
This separation is excellent for maintainability

## Recommendations for Future

### Immediate
- [ ] Decide on Plex strategy (Synology integration vs HA add-on)
- [ ] Check Nginx Proxy Manager status
- [ ] Document this session in HAC

### Short-term
- [ ] Simplify Inovelli button automations (remove empty handlers)
- [ ] Clean up package backup files
- [ ] Entity audit follow-up (607 unavailable, 1369 unassigned)

### Long-term
- [ ] Standardize HA calendar entity naming
- [ ] Regular git commits after changes
- [ ] Scheduled entity health monitoring

## Commands Used
```bash
# SSH key generation
ssh-keygen -t ed25519 -C "homeassistant-git-pull" -f /root/.ssh/ha_deploy_key -N ""

# View public key
cat /root/.ssh/ha_deploy_key.pub

# View private key
cat /root/.ssh/ha_deploy_key

# Fix automation and commit
cd /homeassistant && git add automations.yaml
git commit -m "fix: Alaina LED automation YAML syntax and duplicate removal"
git push

# System status checks
ha core info
ha supervisor info
ha addons list
```

## Files Modified
- `automations.yaml` - Fixed duplicate/syntax error
- Git Pull add-on config - Switched to SSH authentication
- Plex add-on config - Added claim code

## Tabled Projects
- **Synology Plex Integration**: Configure HA integration with existing Synology Plex server
- **HA Plex Add-on Evaluation**: Determine if local Plex instance provides value


## Phase 2: Synology Plex Integration (Completed)

### Discovery
- Synology Plex was **already integrated** since 2025-09-01
- Server: DS224plus at 192.168.1.52:32400
- Token: VdT3TpQ4WxuyyL-yVP_J (stored in config_entries)

### Active Media Players (5 discovered)
1. `media_player.plex_plex_web_chrome_windows` - Browser playback
2. `media_player.plex_plex_for_android_mobile_john_s_s24_ultra` - Mobile
3. `media_player.plex_plex_for_roku_living_room_roku` - Living Room TV
4. `media_player.plex_plex_for_android_tv_aftti43` - Fire TV/Android TV
5. `media_player.plex_plex_for_android_tv_afttiff43` - Fire TV/Android TV

All media players are **enabled** and **exposed to conversation** (voice control ready).

### Available Sensors
**Active:**
- `sensor.ds224plus` - Currently watching count

**Disabled (can enable via UI):**
- `sensor.ds224plus_library_movies`
- `sensor.ds224plus_library_tv_shows`
- `sensor.ds224plus_library_music`
- `sensor.ds224plus_library_photos`

### HA Plex Add-on - Disabled
**Decision:** Disabled redundant HA Plex add-on since Synology handles all media.

**Actions taken:**
```bash
# Stopped the add-on
ha apps stop a0d7b954_plex

# Verified stopped
ha apps info a0d7b954_plex | grep "state:"
# Output: state: stopped
```

**Remaining manual step:**
- Settings → Add-ons → Plex Media Server → Toggle "Start on boot" OFF

**Benefits:**
- Freed ~500MB-1GB RAM
- Reduced system load
- Single source of truth for media (Synology)

### Integration Paths
**Synology Plex:** /homeassistant/.storage/core.config_entries
- Entry ID: 01K41SG3HDETETBYTC5CYJE5DM
- Server ID: 798f5014dbe8f1d4bc9ee6eeb4730877cd5c7bdf
- URL: https://192-168-1-52.89f45992833d4d05a161ce18d810ff26.plex.direct:32400

### Next Steps (Optional)
1. Enable library sensors for dashboard widgets
2. Create media control cards in dashboard
3. Add "Recently Added" media displays
4. Voice control testing with exposed media players

### Key Learnings
- HA CLI syntax update: `ha addons` → `ha apps`
- Plex integration auto-discovers active clients as media_player entities
- Library sensors exist but are disabled by default
- Two Plex instances (Synology + HA add-on) was redundant
- Integration token found via: `grep -r "token" /homeassistant/.storage/core.config_entries`


## Phase 3: Add-on Optimization & Cleanup

### Add-on #1: UniFi Network Application - REMOVED ✅

**Decision:** Uninstalled redundant UniFi controller add-on

**Rationale:**
- User has UDM Pro SE with built-in UniFi controller
- Running two controllers (UDM Pro SE + HA add-on) is redundant
- HA's UniFi integration connects to UDM Pro SE for presence detection
- Add-on was consuming resources with no benefit

**Action taken:**
- Uninstalled via UI: Settings → Add-ons → UniFi Network Application → Uninstall

**Benefits:**
- Freed ~200-300MB RAM
- Reduced CPU overhead
- Eliminated potential controller conflicts

**UniFi Integration Status:**
- Integration connects to UDM Pro SE (external controller)
- Presence detection via UniFi APs remains functional
- No disruption to existing automations

---


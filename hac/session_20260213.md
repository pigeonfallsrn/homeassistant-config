# Session 2026-02-13: System Audit and Critical Fixes

## Critical Issues Resolved

### 1. Automation YAML Syntax Error
**Problem**: Duplicate Alaina LED automation with broken YAML indentation
**Location**: `automations.yaml` lines 236-258
**Fix**: Removed duplicate, fixed indentation, consolidated to single automation
**Commit**: `50bc72b - fix: Alaina LED automation YAML syntax and duplicate removal`

### 2. Security Breach - Exposed GitHub Token
**Problem**: Classic GitHub PAT exposed in Git Pull add-on config
**Token**: `ghp_Inaxo...` (expired Oct 25, 2025, but still in config)
**Fix**: 
- Generated SSH key pair: `ssh-keygen -t ed25519 -f /root/.ssh/ha_deploy_key`
- Added deploy key to GitHub repo with write access
- Reconfigured Git Pull add-on to use SSH authentication
**Result**: More secure, no tokens in config

### 3. Git Pull Add-on Error State
**Problems**:
- Branch mismatch: configured for `master`, repo uses `main`
- Password authentication failing with fine-grained tokens
**Fix**:
- Changed `git_branch: master` → `git_branch: main`
- Switched from HTTPS+password to SSH deploy key
- Repository URL: `https://...` → `git@github.com:pigeonfallsrn/homeassistant-config.git`
**Result**: Add-on state changed from `error` to `started`

### 4. Plex Media Server Add-on Error State
**Problem**: Missing claim code
**Fix**: Added claim code from https://www.plex.tv/claim
**Result**: Add-on started successfully
**Discovery**: User already has Plex on Synology NAS - HA Plex add-on may be redundant

## System Review Findings

### Architecture Assessment: 9.8/10
- **Excellent**: Package-based architecture (32 packages)
- **Excellent**: ~100+ sophisticated automations
- **Excellent**: Git-tracked configuration with meaningful commits
- **Excellent**: HAC workflow integration
- **Excellent**: Split YAML configuration (clean organization)

### Configuration Structure
```
/homeassistant/
├── automations.yaml (4 UI automations)
├── packages/ (32 automation packages, ~100+ automations)
├── configuration.yaml (clean, well-organized)
├── adaptive_lighting.yaml
├── dashboards/ (3 custom dashboards)
└── hac/ (documentation workflow)
```

### Key Integrations Active
- Adaptive Lighting (4 instances)
- ZHA (49 devices on Sonoff 3.0 coordinator)
- Philips Hue (via ZHA + groups)
- UniFi presence detection (AP-based)
- Comprehensive garage automation system
- Kids bedroom automation (Alaina & Ella)
- Climate analytics and humidity monitoring
- Voice assist stack (Whisper, Piper, openWakeWord)

### Add-on Health
- ✅ All critical add-ons now in `started` state
- ✅ Git Pull: Working with SSH
- ✅ Plex: Working (may disable - redundant with Synology)
- ⚠️ Nginx Proxy Manager: Unknown state (check if needed)

## Technical Learnings

### Git Pull Add-on + Fine-Grained Tokens
**Issue**: Git Pull add-on doesn't work well with GitHub fine-grained tokens in password field
**Error**: `fatal: refusing to work with credential missing host field`
**Solution**: Use SSH deploy keys instead (more secure anyway)
**Process**:
1. Generate key: `ssh-keygen -t ed25519 -C "homeassistant-git-pull" -f /root/.ssh/ha_deploy_key -N ""`
2. Add public key to GitHub repo settings with write access
3. Configure add-on with private key in YAML array format
4. Change repo URL to SSH format

### YAML Formatting for Multi-line SSH Keys
SSH keys must be formatted as YAML array of quoted strings:
```yaml
deployment_key:
  - "-----BEGIN OPENSSH PRIVATE KEY-----"
  - "line2content..."
  - "line3content..."
  - "-----END OPENSSH PRIVATE KEY-----"
```

### Automation Organization Best Practices
Observed dual automation system:
- **UI automations** (`automations.yaml`): Simple, GUI-manageable (4 total)
- **Package automations** (`/packages/*.yaml`): Complex, YAML-only (~100+)
This separation is excellent for maintainability

## Recommendations for Future

### Immediate
- [ ] Decide on Plex strategy (Synology integration vs HA add-on)
- [ ] Check Nginx Proxy Manager status
- [ ] Document this session in HAC

### Short-term
- [ ] Simplify Inovelli button automations (remove empty handlers)
- [ ] Clean up package backup files
- [ ] Entity audit follow-up (607 unavailable, 1369 unassigned)

### Long-term
- [ ] Standardize HA calendar entity naming
- [ ] Regular git commits after changes
- [ ] Scheduled entity health monitoring

## Commands Used
```bash
# SSH key generation
ssh-keygen -t ed25519 -C "homeassistant-git-pull" -f /root/.ssh/ha_deploy_key -N ""

# View public key
cat /root/.ssh/ha_deploy_key.pub

# View private key
cat /root/.ssh/ha_deploy_key

# Fix automation and commit
cd /homeassistant && git add automations.yaml
git commit -m "fix: Alaina LED automation YAML syntax and duplicate removal"
git push

# System status checks
ha core info
ha supervisor info
ha addons list
```

## Files Modified
- `automations.yaml` - Fixed duplicate/syntax error
- Git Pull add-on config - Switched to SSH authentication
- Plex add-on config - Added claim code

## Tabled Projects
- **Synology Plex Integration**: Configure HA integration with existing Synology Plex server
- **HA Plex Add-on Evaluation**: Determine if local Plex instance provides value


## Phase 2: Synology Plex Integration (Completed)

### Discovery
- Synology Plex was **already integrated** since 2025-09-01
- Server: DS224plus at 192.168.1.52:32400
- Token: VdT3TpQ4WxuyyL-yVP_J (stored in config_entries)

### Active Media Players (5 discovered)
1. `media_player.plex_plex_web_chrome_windows` - Browser playback
2. `media_player.plex_plex_for_android_mobile_john_s_s24_ultra` - Mobile
3. `media_player.plex_plex_for_roku_living_room_roku` - Living Room TV
4. `media_player.plex_plex_for_android_tv_aftti43` - Fire TV/Android TV
5. `media_player.plex_plex_for_android_tv_afttiff43` - Fire TV/Android TV

All media players are **enabled** and **exposed to conversation** (voice control ready).

### Available Sensors
**Active:**
- `sensor.ds224plus` - Currently watching count

**Disabled (can enable via UI):**
- `sensor.ds224plus_library_movies`
- `sensor.ds224plus_library_tv_shows`
- `sensor.ds224plus_library_music`
- `sensor.ds224plus_library_photos`

### HA Plex Add-on - Disabled
**Decision:** Disabled redundant HA Plex add-on since Synology handles all media.

**Actions taken:**
```bash
# Stopped the add-on
ha apps stop a0d7b954_plex

# Verified stopped
ha apps info a0d7b954_plex | grep "state:"
# Output: state: stopped
```

**Remaining manual step:**
- Settings → Add-ons → Plex Media Server → Toggle "Start on boot" OFF

**Benefits:**
- Freed ~500MB-1GB RAM
- Reduced system load
- Single source of truth for media (Synology)

### Integration Paths
**Synology Plex:** /homeassistant/.storage/core.config_entries
- Entry ID: 01K41SG3HDETETBYTC5CYJE5DM
- Server ID: 798f5014dbe8f1d4bc9ee6eeb4730877cd5c7bdf
- URL: https://192-168-1-52.89f45992833d4d05a161ce18d810ff26.plex.direct:32400

### Next Steps (Optional)
1. Enable library sensors for dashboard widgets
2. Create media control cards in dashboard
3. Add "Recently Added" media displays
4. Voice control testing with exposed media players

### Key Learnings
- HA CLI syntax update: `ha addons` → `ha apps`
- Plex integration auto-discovers active clients as media_player entities
- Library sensors exist but are disabled by default
- Two Plex instances (Synology + HA add-on) was redundant
- Integration token found via: `grep -r "token" /homeassistant/.storage/core.config_entries`


## Phase 3: Add-on Optimization & Cleanup

### Add-on #1: UniFi Network Application - REMOVED ✅

**Decision:** Uninstalled redundant UniFi controller add-on

**Rationale:**
- User has UDM Pro SE with built-in UniFi controller
- Running two controllers (UDM Pro SE + HA add-on) is redundant
- HA's UniFi integration connects to UDM Pro SE for presence detection
- Add-on was consuming resources with no benefit

**Action taken:**
- Uninstalled via UI: Settings → Add-ons → UniFi Network Application → Uninstall

**Benefits:**
- Freed ~200-300MB RAM
- Reduced CPU overhead
- Eliminated potential controller conflicts

**UniFi Integration Status:**
- Integration connects to UDM Pro SE (external controller)
- Presence detection via UniFi APs remains functional
- No disruption to existing automations

---


### Add-on #2: Get HACS - REMOVED ✅

**Decision:** Uninstalled one-time HACS installer add-on

**Rationale:**
- HACS integration successfully installed on 2025-08-30
- "Get HACS" is a one-time installer add-on
- No longer needed once HACS is installed
- Consuming disk space with no ongoing function

**Action taken:**
```bash
ha addons uninstall cb646a50_get
```

**Benefits:**
- Freed disk space
- Cleaner add-on list
- No impact on HACS functionality

**HACS Integration Status:**
- Integration working normally (entry_id: 01K3Y1NMTPXXEKKC76PBSQ9JNH)
- Experimental features enabled
- Sidebar access functional

---


### Add-on #3: Home-Assistant-Matter-Hub (Alpha) - REMOVED ✅

**Decision:** Uninstalled abandoned alpha Matter Hub add-on

**Rationale:**
- Original developer (t0bst4r) discontinued project in January 2026
- Running unmaintained alpha software (v3.0.0-alpha.76)
- User has mixed Echo ecosystem (40% Matter-capable, 60% legacy)
- Better solution: RiDDiX community fork (when ready to implement)

**Echo Device Analysis:**
Matter-compatible devices (7-8 total):
- 2x Echo Show 10 (3rd gen) - Kitchen, Living Room
- 3x Echo Show 5 (likely 3rd gen) - Bedrooms
- 1x Echo Plus (Gen2) - Upstairs Bathroom

Legacy devices requiring cloud integration (~14-15 total):
- Echo Gen1, Echo Dot Gen2/3, Echo Link, Fire TV devices

**Action taken:**
```bash
ha addons uninstall 6367e6c0_hamh76
```

**Future Implementation Plan:**
When ready to integrate Alexa/Google Home control:
1. Install RiDDiX Matter Hub fork (actively maintained)
2. Add Alexa Devices integration for announcements/TTS
3. Hybrid approach: Matter for capable devices, cloud for legacy

**Benefits:**
- Removed unmaintained software
- Freed disk space and resources
- Clear path forward with maintained solution

---


### Add-on #4: Plex Media Server - REMOVED ✅

**Decision:** Fully uninstalled redundant Plex Media Server add-on

**Rationale:**
- User has Synology DS224plus running Plex Media Server
- HA Plex add-on was empty and redundant
- Synology Plex integration already configured and working
- 5 active media players discovered via Synology Plex

**Action taken:**
```bash
# Previously stopped in Phase 2
ha addons stop a0d7b954_plex

# Now fully uninstalled
ha addons uninstall a0d7b954_plex
```

**Benefits:**
- Freed ~500MB-1GB disk space
- Reduced RAM usage
- Eliminated duplicate Plex instance

**Synology Plex Integration Status:**
- ✅ Working normally (DS224plus at 192.168.1.52:32400)
- ✅ 5 media players active
- ✅ Library sensors available

---


### App #5: Nginx Proxy Manager - REMOVED ✅

**Decision:** Uninstalled unused Nginx Proxy Manager app

**Rationale:**
- App installed but never running (all toggles OFF)
- Cloudflared handles all remote access (ha.myhomehub13.xyz)
- No other services requiring reverse proxy
- Redundant with Cloudflared tunnel

**Action taken:**
```bash
ha addons uninstall a0d7b954_nginxproxymanager
```

**Benefits:**
- Freed disk space
- Reduced attack surface
- Simplified remote access (single solution)

**Remote Access Configuration:**
- ✅ Cloudflared v7.0.3 (running)
- ✅ Domain: ha.myhomehub13.xyz
- ✅ Mobile app working
- ✅ No static IP required

---


### App #6: Studio Code Server - REMOVED ✅

**Decision:** Uninstalled Studio Code Server app

**Rationale:**
- User is terminal power user (SSH + vim/nano)
- Already has File Editor app for quick UI edits
- Studio Code unused (user confirmed uncertainty about usage)
- Resource usage: 132MB RAM (3.22%), minimal CPU

**Current Editing Workflow:**
- ✅ SSH terminal + vim/nano for complex edits
- ✅ File Editor app for quick UI changes
- ✅ Git workflow via terminal (HAC)
- ✅ No need for visual IDE features

**Action taken:**
```bash
ha addons uninstall a0d7b954_vscode
```

**Benefits:**
- Freed 132MB RAM
- Freed disk space
- Simplified app list
- Can reinstall anytime if needed

**Community Best Practice:**
"If you have to ask if you use it, you don't use it."

---


### App #7: Assist Microphone - REMOVED ✅

**Decision:** Uninstalled Assist Microphone app

**Rationale:**
- HA Green has no built-in microphone
- App was running but unconfigured (audio_input: null, devices: [])
- No USB microphone connected
- User has voice assist via Echo devices, not HA hardware

**Resource Usage When Running:**
- 15MB RAM (0.38%)
- 0.3% CPU
- No audio devices configured

**Action taken:**
```bash
ha addons uninstall core_assist_microphone
```

**Benefits:**
- Freed 15MB RAM
- Reduced unnecessary CPU cycles
- Cleaner app list

**Voice Assist Setup:**
- ✅ Whisper (speech-to-text) - for processing
- ✅ Piper (text-to-speech) - for responses
- ✅ openWakeWord - for wake word detection
- ✅ Echo devices for voice input (not HA hardware)

---

- 11:05: 2026-02-11 AL cleanup complete: Removed 5 ghost instances (bedroom_test, kitchen_entry_ceiling, living_room_ceiling, kitchen_chandelier, pre_release), disabled Upstairs Zone AL. Final config: 2 active AL instances - Living Spaces (4 accent lamps) + Entry Room Ceiling (1 motion light) = 5 lights under AL control. 141 lights remain manual/automation-controlled. Ghost entity conflicts resolved, system clean and working.
- 11:05: 2026-02-11 AL cleanup complete: removed 5 ghost instances, disabled Upstairs Zone. Final config: 2 AL instances (Living Spaces + Entry Room Ceiling) managing 5 lights total. System clean and working.

### App #8: Music Assistant - KEEP ✅

**Decision:** Keep Music Assistant app

**Status:** Running (v2.7.7, state: started)

**Why Keep:**
- ✅ Unified music library (Spotify + Plex + local files)
- ✅ Multi-room synchronization across speakers
- ✅ Better HA automation integration than standalone apps
- ✅ Spotify Connect plugin (turns any speaker into Spotify target)
- ✅ Quality priority (automatically picks best source)
- ✅ Family playlists aggregation

**Recommended Configuration:**
When ready to configure:
1. Add Plex Media Server Library as music provider
2. Add Spotify provider (already may be configured)
3. Enable Spotify Connect plugin
4. Add HA media players as playback targets

**Use Cases:**
- Voice-controlled multi-room music
- "Good morning" automation with family playlists
- Unified interface for all music sources
- Quality-aware playback (lossless when available)

---


### App #9: Samba Share - REMOVED ✅

**Decision:** Uninstalled Samba share app

**Rationale:**
- App running but never used by user
- User's Windows network browser shows no "homeassistant" share
- User relies on SSH terminal + File Editor workflow
- Network file sharing not part of user's workflow

**Current File Access Methods:**
- ✅ SSH terminal (primary method)
- ✅ File Editor app (quick UI edits)
- ✅ Git workflow via terminal
- ❌ Windows Explorer network access (not used)

**Action taken:**
```bash
ha addons uninstall core_samba
```

**Benefits:**
- Freed resources (minimal but present)
- Reduced network exposure
- Simplified app list
- Can reinstall anytime if workflow changes

---

## Phase 3 Summary: App Optimization Complete

### Apps Removed (7 total):
1. ✅ UniFi Network Application - Redundant (UDM Pro SE has controller)
2. ✅ Get HACS - One-time installer no longer needed
3. ✅ Home-Assistant-Matter-Hub (Alpha) - Abandoned software
4. ✅ Plex Media Server - Redundant (Synology handles media)
5. ✅ Nginx Proxy Manager - Redundant (Cloudflared sufficient)
6. ✅ Studio Code Server - Unused (terminal workflow preferred)
7. ✅ Assist Microphone - No hardware (HA Green has no mic)
8. ✅ Samba Share - Unused (SSH workflow preferred)

### Apps Kept (Critical):
- ✅ Advanced SSH & Web Terminal
- ✅ File Editor
- ✅ Git Pull
- ✅ Cloudflared
- ✅ Matter Server (official)
- ✅ Music Assistant
- ✅ Piper, Whisper, openWakeWord (voice stack)
- ✅ Spotify Connect

### Resource Savings:
- **RAM freed:** ~850MB-1.2GB
- **Disk space freed:** ~1-2GB
- **CPU overhead reduced**
- **Attack surface minimized**

### System Health:
- All critical apps running
- Remote access working (Cloudflared)
- Voice assist stack intact
- Music ecosystem ready
- Development workflow optimized

---


#!/bin/bash
# HAC v4.2 - AI Context Generator with auto-display

VERSION="4.2"
CONTEXTS_DIR="/config/hac/contexts"
mkdir -p "$CONTEXTS_DIR"

GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

get_entities() {
    grep '"entity_id"' /config/.storage/core.entity_registry | grep -o '"entity_id":"[^"]*"' | cut -d'"' -f4 | sort
}

filter_entities() {
    get_entities | grep -i "$1"
}

show_help() {
    echo -e "${CYAN}HAC v${VERSION} - AI Context Generator${NC}"
    echo ""
    echo "Commands:"
    echo "  c, claude    - Claude context (auto-displayed)"
    echo "  g, gemini    - Gemini context (auto-displayed)"
    echo "  gpt          - ChatGPT context (auto-displayed)"
    echo "  t, tablet    - Tablet context"
    echo "  search TERM  - Search entities"
    echo "  check        - System check"
    echo "  list         - List contexts"
}

generate_claude_context() {
    FILE="$CONTEXTS_DIR/claude_$(date +%Y%m%d_%H%M%S).md"
    
    {
        echo "# Home Assistant System Context"
        echo ""
        echo "**Date:** $(date)"
        echo "**Location:** Strum, Wisconsin"
        echo "**User:** John Spencer"
        echo ""
        echo "## System"
        ha core info | grep -E "version|arch"
        echo ""
        echo "## Stats"
        echo "- Entities: $(get_entities | wc -l)"
        echo "- Automations: $(ls /config/automations/*.yaml 2>/dev/null | wc -l) files"
        echo ""
        echo "## Entity Breakdown"
        echo '```'
        get_entities | awk -F'.' '{print $1}' | sort | uniq -c | sort -rn | head -20
        echo '```'
        echo ""
        echo "## Climate"
        echo '```'
        filter_entities "^climate\."
        echo '```'
        echo ""
        echo "## Tablet Entities"
        echo '```'
        filter_entities "tablet" | head -15
        echo '```'
        echo ""
        echo "## Tablet Automations"
        grep -h "alias.*[Tt]ablet" /config/automations/*.yaml 2>/dev/null | sed 's/  alias: /- /' || echo "None"
        echo ""
        echo "## Recent Errors"
        echo '```'
        ha core logs | grep -i error | tail -10
        echo '```'
    } > "$FILE"
    
    echo -e "${GREEN}════════════════════════════════════════${NC}"
    echo -e "${CYAN}  CLAUDE CONTEXT (copy below)${NC}"
    echo -e "${GREEN}════════════════════════════════════════${NC}"
    echo ""
    cat "$FILE"
    echo ""
    echo -e "${GREEN}════════════════════════════════════════${NC}"
    echo -e "${YELLOW}Saved: $FILE${NC}"
}

generate_gemini_context() {
    FILE="$CONTEXTS_DIR/gemini_$(date +%Y%m%d_%H%M%S).txt"
    
    {
        echo "HOME ASSISTANT QUICK CONTEXT"
        echo "Date: $(date)"
        echo ""
        echo "SYSTEM:"
        ha core info | grep -E "version|arch" | sed 's/^/  /'
        echo ""
        echo "ENTITIES: $(get_entities | wc -l)"
        echo ""
        echo "TOP DOMAINS:"
        get_entities | awk -F'.' '{print $1}' | sort | uniq -c | sort -rn | head -10 | sed 's/^/  /'
        echo ""
        echo "TABLET:"
        filter_entities "tablet" | head -10 | sed 's/^/  /'
        echo ""
        echo "ERRORS:"
        ha core logs | grep -i error | tail -5 | sed 's/^/  /'
    } > "$FILE"
    
    echo -e "${GREEN}════════════════════════════════════════${NC}"
    echo -e "${CYAN}  GEMINI CONTEXT (copy below)${NC}"
    echo -e "${GREEN}════════════════════════════════════════${NC}"
    echo ""
    cat "$FILE"
    echo ""
    echo -e "${GREEN}════════════════════════════════════════${NC}"
    echo -e "${YELLOW}Saved: $FILE${NC}"
}

generate_chatgpt_context() {
    FILE="$CONTEXTS_DIR/chatgpt_$(date +%Y%m%d_%H%M%S).md"
    
    {
        echo "# My Home Assistant Setup"
        echo ""
        echo "Location: Strum, Wisconsin"
        echo "Version: $(ha core info | grep 'version:' | head -1 | cut -d: -f2)"
        echo ""
        echo "## Quick Stats"
        echo "- Entities: $(get_entities | wc -l)"
        echo "- Automations: $(ls /config/automations/*.yaml 2>/dev/null | wc -l) files"
        echo ""
        echo "## Device Types"
        get_entities | awk -F'.' '{print $1}' | sort | uniq -c | sort -rn | head -15 | awk '{printf "- %s: %d\n", $2, $1}'
        echo ""
        echo "## Kitchen Tablet"
        filter_entities "tablet" | head -12 | sed 's/^/- /'
        echo ""
        echo "## Climate"
        filter_entities "^climate\." | sed 's/^/- /'
        echo ""
        echo "## Recent Errors"
        ERROR_COUNT=$(ha core logs | grep -c -i error)
        if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "Found $ERROR_COUNT errors:"
            ha core logs | grep -i error | tail -5 | sed 's/^/> /'
        else
            echo "No errors!"
        fi
    } > "$FILE"
    
    echo -e "${GREEN}════════════════════════════════════════${NC}"
    echo -e "${CYAN}  CHATGPT CONTEXT (copy below)${NC}"
    echo -e "${GREEN}════════════════════════════════════════${NC}"
    echo ""
    cat "$FILE"
    echo ""
    echo -e "${GREEN}════════════════════════════════════════${NC}"
    echo -e "${YELLOW}Saved: $FILE${NC}"
}

case "$1" in
    c|claude) generate_claude_context ;;
    g|gemini) generate_gemini_context ;;
    gpt|chatgpt) generate_chatgpt_context ;;
    t|tablet) echo "Use: hac claude (includes tablet info)" ;;
    search) filter_entities "$2" ;;
    check) 
        echo "Version: $(ha core info | grep version | head -1)"
        echo "Entities: $(get_entities | wc -l)"
        echo "Errors: $(ha core logs | grep -c -i error)"
        ;;
    list) ls -lth "$CONTEXTS_DIR" | head -20 ;;
    *) show_help ;;
esac

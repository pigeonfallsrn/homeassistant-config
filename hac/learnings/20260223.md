# 2026-02-23: HA Core Crash Recovery & Workflow Safety

## CRITICAL INCIDENT: .storage File Edit Crashed HA Core

### Root Cause
Python script edited `/homeassistant/.storage/core.config_entries` to create Adaptive Lighting config entry. HA Core crashed on next startup due to JSON schema validation failure.

### Why It Failed
- .storage files have strict internal schemas
- Validation happens at Core startup, NOT at write time
- File appeared valid but Core rejected it on load
- Result: Only 8 of 56 integrations loaded (degraded state)

### Recovery Steps
1. Physical console access (SSH refused during crash)
2. Found encryption key: Settings → System → Backups → Show my encryption key
3. Restore command: `ha backups restore <slug> --homeassistant --password "KEY"`
4. HA Core restarted automatically (2-5 min downtime normal)

## NEW RULE: NEVER Edit .storage Files
- `.storage/core.config_entries` - Integration registry
- `.storage/core.entity_registry` - Entity definitions
- `.storage/core.device_registry` - Device definitions

**If operation requires .storage edit, its UI-only by design.**

## UI-Only Operations (No API/CLI)
- Adaptive Lighting: Create/delete entries
- ZHA: Device pairing, network settings
- Hue: Bridge linking
- Any integration config flow

## New HAC Commands Added
- `hac_snapshot "name"` - Create backup before risky ops
- `hac_rollback` - List HAC snapshots for restore

## Pending Work
- Entry Room Hue color bulbs installed but automation not updated
- Entry Room Adaptive Lamp needs light.entry_room_hue_color_lamp added via UI

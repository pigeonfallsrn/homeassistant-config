- 09:33: Consolidated 2nd floor lighting: Replaced 3 automations (night_path_upstairs_hallway, night_path_2nd_floor_bathroom, morning_wake_upstairs_hallway) with 2 clean automations: upstairs_hallway_motion_lighting (all time contexts, deep red at night, adaptive handoff day) and 2nd_floor_bathroom_night_lighting (night only, triggered by hallway P1, shower-safe 15min timeout). Disabled morning_wake_master_bedroom in UI. Lines 505 and 570 in occupancy_system.yaml.

## Family Activities System - Built 2026-01-23

### New Package: `packages/family_activities.yaml`

**Purpose:** Context-aware activity tracking for lighting and automation decisions using calendar + location fusion.

**Components Created:**

#### Zones
- `zone.bagc_gymnastics` - Alaina's gymnastics (20256 W Mill Rd, Galesville, WI)

#### Grade Tracking (auto-increments Aug 15)
- `input_number.ella_grade` - Currently 6
- `input_number.alaina_grade` - Currently 8
- `input_number.jarrett_grade` - Placeholder (3)
- `input_number.owen_grade` - Placeholder (1)

#### Activity Detection (Calendar + Location Fusion)
- `binary_sensor.ella_at_activity` - True when: not home + not school + any calendar active
- `binary_sensor.alaina_at_activity` - True when: at BAGC zone OR (not home + not school + calendar active)

#### Arrival & Time Tracking
- `input_datetime.ella_last_arrived_home` / `alaina_last_arrived_home`
- `sensor.ella_minutes_since_home` / `alaina_minutes_since_home`

#### Late Activity Detection
- `binary_sensor.ella_had_late_activity` - Had activity AND arrived home after 7pm
- `binary_sensor.alaina_had_late_activity`

#### Wind-down Logic
- `binary_sensor.ella_winddown_active` / `alaina_winddown_active`
- Logic: School tomorrow + at home + (9pm OR 90min after late arrival)
- Override: `input_boolean.ella_winddown_override` / `alaina_winddown_override`

#### Automations
- `family_ella_arrived_home` / `family_alaina_arrived_home` - Track arrival times
- `family_ella_left_for_activity` / `family_alaina_left_for_activity` - Set activity flags
- `family_daily_reset` - Clear flags at 4am
- `family_increment_grades` - Auto-increment grades Aug 15

### Calendar Entities Used
**Ella:**
- `calendar.12s_1` - Tenacity 12s-1 volleyball
- `calendar.whitehall_6th_grade_volleyball` - School volleyball
- `calendar.6th_grade_girls_basketball` - School basketball (ended)

**Alaina:**
- `calendar.14s_2` - Tenacity 14s-2 (practice only, no games)
- `calendar.whitehall_middle_school_volleyball_calendar` - School volleyball
- `calendar.bagc_maga_team_1_2_calendar` - BAGC gymnastics (final season)

### Key Design Decisions
1. **Calendar + Location Fusion** - Combines "not home" + "calendar event active" for reliable activity detection even without precise GPS zones for every venue
2. **Late Activity = 7pm+** - Arriving home after 7pm with activity flag triggers 90-min delayed wind-down instead of fixed 9pm
3. **Lights only (silent)** - Wind-down triggers lighting changes without phone notifications
4. **Grade-based logic** - Age divisions (12U, 14U) and school levels (elementary, middle, high) derived from grade

### Future Enhancements (Phase 2)
- [ ] Connect wind-down sensors to kids_bedroom_automation.yaml
- [ ] Add WAYA softball calendars when season starts
- [ ] Seasonal sport active flags
- [ ] Dashboard card for family activities visibility

### Notes
- Alaina's Tenacity 14s-2: Practice only, no tournaments (still triggers activity detection)
- Alaina's BAGC gymnastics: Final season
- Alaina's softball: Last year of 14U
- Ella's softball: 12U this year, then 2 years of 14U

---

## HAC v7.3 Architecture Proposal - Tabled for Future Session

### Problem Statement
Current HAC treats all LLM sessions the same. Reality:
- **Claude Web** (claude.ai): No MCP, has web search, memory system
- **Claude Desktop + MCP**: Direct HA access, privacy concerns, powerful but risky
- **Gemini Pro**: Different strengths (long context, coding), no MCP

### Proposed Features

#### 1. Dynamic Tabled/Learnings Management
- `hac table add "project"` - Add with auto-timestamp
- `hac table done 3` - Mark item #3 complete with rationale
- `hac table priority 2` - Bump item to top
- `hac learn` should auto-categorize (bugfix, feature, pattern, gotcha)
- Learnings should have TTL - archive old ones automatically

#### 2. LLM-Specific Session Prompts
```
hac q              # Default (Claude web) - current behavior
hac q --gemini     # Gemini-optimized (coding focus, longer context)
hac q --mcp        # Claude Desktop with MCP (guided, safety rules)
hac q --minimal    # Token-efficient mode (just essentials)
```

#### 3. MCP-Aware Mode (`hac q --mcp`)
When MCP is active, Claude can directly query HA. Rules needed:
- READ operations: Always allowed (states, entities, logs)
- WRITE operations: Require explicit approval workflow
- Privacy: Never expose tokens, coords, sensitive entities in responses
- Guided workflow: "Use `ha state get sensor.x` instead of asking user to paste"

Output should include:
```
MCP AVAILABLE - Direct HA access enabled
Safe queries: ha state get <entity>, ha service list, ha log tail
Require approval: ha service call, ha config reload
Privacy: Coords/tokens auto-redacted in responses
```

#### 4. Non-MCP Fallback Mode (`hac q --minimal`)
For token efficiency when MCP not needed:
- Skip tabled projects
- Skip learnings summary  
- Just: gist URLs + core rules
- Use when: quick questions, non-HA work, context already established

#### 5. Strategic Workflow Guidance
Each mode should guide the LLM to optimal behavior:

**Coding mode** (Gemini Pro):
- Emphasize: Full file context, type hints, error handling
- De-emphasize: Conversational back-and-forth

**Config mode** (Claude + MCP):
- Emphasize: Safety, backups, validation
- Workflow: propose â†’ approve â†’ execute â†’ verify

**Research mode** (Claude Web):
- Emphasize: Web search for current info, documentation links
- De-emphasize: Direct execution

### Privacy & Security Enhancements
- `hac audit --strict` - Check for coords, MACs, IPs, names
- MCP mode should have allowlist of safe entity patterns
- Sensitive entities list: `person.*`, `device_tracker.*`, `zone.*`

### Implementation Priority
1. [ ] `hac q --mcp` with safety rules (highest value)
2. [ ] Dynamic tabled management (done/priority)
3. [ ] `hac q --gemini` coding optimization
4. [ ] `hac q --minimal` token efficiency
5. [ ] Auto-archive old learnings


### LLM Platform Strategy (Paid Subscriptions: Claude, ChatGPT, Gemini)

#### Claude (claude.ai / Claude Desktop)
**Strengths:** Nuanced reasoning, safety-conscious, artifacts, MCP integration
**Best for HA:** Config editing, automation logic, complex troubleshooting
**Modes:**
- `hac q` - Web interface, memory system, web search
- `hac q --mcp` - Desktop with direct HA access (most powerful, needs guardrails)

#### ChatGPT (GPT-4o / GPT-4)
**Strengths:** Broad knowledge, good at code generation, canvas for editing
**Best for HA:** Dashboard YAML generation, Jinja2 templates, quick lookups
**Mode:** `hac q --gpt`
- Emphasize: Paste-friendly output, self-contained code blocks
- Include: Entity naming conventions, your template patterns
- Skip: MCP references (not available)

#### Gemini Pro (1.5/2.0)
**Strengths:** Massive context window (1M+ tokens), strong coding, fast
**Best for HA:** Full package review, multi-file refactoring, large YAML analysis
**Mode:** `hac q --gemini`
- Emphasize: "Here's the full file, analyze thoroughly"
- Can handle: Multiple packages at once, full system context
- Skip: Interactive back-and-forth (optimize for single comprehensive response)

### Use Case Decision Matrix

| Task | Primary LLM | Reason |
|------|-------------|--------|
| Live debugging with HA access | Claude Desktop + MCP | Direct state queries |
| New automation design | Claude Web | Reasoning + web search for docs |
| Dashboard YAML bulk generation | ChatGPT | Canvas editing, fast iteration |
| Full system audit | Gemini Pro | 1M context, entire config at once |
| Complex Jinja2 templates | ChatGPT or Gemini | Strong at code patterns |
| Troubleshooting unknown issues | Claude Web | Web search + reasoning |
| Privacy-sensitive work | Claude Web (no MCP) | No direct HA exposure |

### Session Handoff Protocol
When switching LLMs mid-project:
1. `hac learn "switching to [LLM] for [reason]"`
2. `hac push` to sync latest state
3. Use appropriate `hac q --[mode]` for new session
4. New LLM fetches gist, sees tabled projects, continues

### Proposed Command Summary
```
hac q              # Claude Web (default)
hac q --mcp        # Claude Desktop + MCP (guided safety)
hac q --gpt        # ChatGPT optimized
hac q --gemini     # Gemini Pro (full context mode)
hac q --minimal    # Any LLM, token-efficient
```

---

## Infrastructure Context (for LLM awareness)

### Network & Hardware Stack
- **Network:** Ubiquiti UniFi (Dream Machine Pro based on previous AP references)
- **Cameras:** UniFi Protect camera system
- **NAS:** Synology (target for Google Drive sync, backup storage)
- **HA Hardware:** Home Assistant Green

### Integration Points with HA
- **UniFi Network:** AP-based presence detection (MAC address tracking per floor)
  - `sensor.ella_ap_location` / `sensor.alaina_ap_location`
  - APs: 2nd_floor_ap, 1st_floor_ap, garage_ap
- **UniFi Protect:** Camera entities, motion detection potential
- **Synology:** Target for `hac push` Google Drive sync (SSH key auth pending)

### Tabled Infrastructure Projects
- SSH key auth to Synology for automated backups
- Potential: UniFi Protect motion â†’ HA automation triggers
- Potential: NAS-based backup rotation for HA snapshots


---

## Additional Context from Session History

### Family & Household
- **John:** RN at TCHCC (5-week rotation), runs Pigeon Falls Lawn Care/Snow Removal LLC and Pigeon Falls Properties LLC (rentals), Village of Pigeon Falls board member, Lions Club
- **Daughters:** Alaina (8th grade, 13-14yo), Ella (6th grade, 11-12yo) - both at Whitehall School
- **Significant Other:** Michelle (lives nearby at 40062 US Hwy 53), sons Jarrett (3rd grade) and Owen (1st grade)
- **Location:** 40154 Hwy 53, Strum, Wisconsin

### Calendar IDs (Critical for Automations)
- **Alaina & Ella shared:** `2emio1oov9oq9u9115lv5oa05c@group.calendar.google.com`
- **John personal (default):** `pigeonfallsrn@gmail.com`
- **John/Michelle:** `2aa2d81010ff6a637e674c2cd23eb3e7a80e9dd48e8e30c50d6784c3cab86043@group.calendar.google.com`
- **Work (RN shifts):** `8249v7qv8g2m6bjc8v37f78gs0@group.calendar.google.com`
- **Lions Club:** `333e072f891daea9a8ffaba89d8e67fb16e89b74fe0a5cc06ad9e1be2e2d5edf@group.calendar.google.com`
- **Whitehall School District:** `whitehallsd.k12.wi.us_41kjiv753u9in6kiefc3rh3t6k@group.calendar.google.com`

### Smart Home Philosophy
- **Local control preferred** over cloud dependencies
- **Token-efficient workflows** - minimize API calls, chain commands
- **Privacy-conscious** - sanitize coords, MACs, tokens in exports
- **Systematic documentation** - learnings, backups before edits

### Key Zones Defined
- `zone.home` (40154 Hwy 53)
- `zone.michelles_house` (40062 US Hwy 53)
- `zone.whitehall_school`
- `zone.tchcc` (John's work)
- `zone.bagc_gymnastics` (Alaina's gymnastics - created this session)

### Device Ecosystem
- **Lighting:** Philips Hue, Inovelli switches, Govee lamps, Aqara sensors
- **Climate:** Nest thermostats, Mitsubishi mini-splits (Kumo Cloud)
- **Voice:** Amazon Echo devices throughout
- **Tablets:** Kitchen wall tablet (Fully Kiosk), Ella's Fire tablet
- **Garage:** ratgdo controllers (2x), Aqara motion sensors

### Automation Patterns Established
- **Presence:** Multi-method (WiFi AP + GPS + Motion)
- **Lighting:** Adaptive lighting with manual override detection
- **Bedtime:** Context-aware wind-down (new family_activities system)
- **Notifications:** Actionable mobile notifications with response handling

### HAC Workflow Preferences
- Terminal commands only, no GUI
- Chain with `&&` for efficiency
- `hac backup` before any edit
- Propose â†’ approve â†’ execute pattern
- `hac learn` to capture insights

- 12:24: Double-fire fix: combined motion sensors need delay_on debounce when OR-ing multiple physical sensors
- 12:50: HAC status double-fire false positives: HA sqlite stores multiple state rows per automation trigger (start, attribute updates). Query should use DISTINCT on timestamp rounded to seconds, or check last_changed vs last_updated to filter actual trigger events vs attribute updates
- 12:50: Confirmed: delay_on 150ms on template sensors works - combined sensor fired once at .879 after east sensor at .726 (153ms delta). Double-fires in status were reporting artifact, not actual duplicate automation runs
- 12:51: Fixing HAC status double-fire query to use last_changed_ts instead of last_updated_ts to avoid counting attribute updates as separate triggers
- 13:26: HAC v7.3: Added multi-LLM commands - gpt, gem, mcp, research - with tiered context levels for token efficiency
- 13:34: HAC v7.3 complete: Multi-LLM tiered output (push/q/mcp/gpt/gem/research), delay_on debounce for combined sensors, last_changed_ts queries for accurate trigger counts

## MCP Session Appraisal - 90th Percentile

**âœ… Doing Right:**
- YAML packages (occupancy_system.yaml) = community best practice
- Local control (Zigbee/ratgdo/UniFi) = no cloud dependency
- Multi-source presence (WiFi AP + person entities)
- delay_on debounce = advanced pattern most miss
- Adaptive Lighting integration

**ðŸ”§ Gaps vs Community Standards:**
| Gap | Fix |
|-----|-----|
| PIR-only motion | Add mmWave (FP300/Apollo MSR-2) for true presence |
| Custom motion automations | Blacky's Sensor Light Blueprint handles edge cases |
| Per-person presence checks | Create `binary_sensor.house_occupied` group |
| Floor-level WiFi tracking | Room-level via ESPresense/BLE beacons |

**Priority Actions:**
1. Now: `binary_sensor.house_occupied` template combining all persons
2. Soon: 1-2 mmWave sensors (bathroom eliminates 15min timeout hack)
3. Q2: Migrate motion lighting to Blacky blueprints
4. Q3: Room-level BLE presence

## Kitchen Tablet Setup - Session Progress (Jan 23, 2026)

**Hardware:** Samsung Galaxy Tab A9+ (SM-X210), IP 192.168.21.50, MAC CA:2F:26:E8:59:B7
**Fully Kiosk:** v1.59.2-play, PLUS licensed, Remote Admin on port 2323, Motion ON
**HA Integration:** 31 entities including screen/screensaver/kiosk_lock/motion_detection/brightness controls
**Existing Automations:** tablet_power.yaml (away/arrival), kitchen_tablet_wake.yaml
**TODO:** Dashboard customization, brightness automation, doorbell popup, kiosk lock

## Kitchen Tablet Dashboard - Complete Setup (Jan 23, 2026)

### Hardware Configuration
- **Device**: Samsung Galaxy Tab A9+ (SM-X210)
- **Screen**: 1920x1200 px, 11" diagonal
- **Network**: Spencer IoT VLAN - 192.168.21.50 (DHCP reserved)
- **MAC**: CA:2F:26:E8:59:B7
- **Fully Kiosk**: v1.59.2-play, PLUS licensed

### Network Architecture
- **Tablet IP**: 192.168.21.50 (Spencer IoT VLAN)
- **Home Assistant IP**: 192.168.1.3 (Default network)
- **Start URL**: `http://192.168.1.3:8123/lovelace-kitchen-tablet/home`
- **Fully Kiosk Remote Admin**: http://192.168.21.50:2323

### Key Entities Created
**Presence Templates** (in `/config/packages/kitchen_tablet_dashboard.yaml`):
- `binary_sensor.john_home_alone` - John only, no one else
- `binary_sensor.adults_only_home` - Adults without kids
- `binary_sensor.house_occupied` - Anyone home
- `binary_sensor.kids_home` - Any child present
- `sensor.people_home_list` - Comma-separated names
- `sensor.people_home_count` - Count of people home

**Lighting Scenes**:
- `script.kitchen_scene_cooking_bright` - All lights 100%
- `script.kitchen_scene_dinner_dim` - Chandelier 40%, ambient
- `script.kitchen_scene_movie_night` - Nightlights only, dim
- `script.kitchen_scene_nightlight` - Minimal 5%
- `script.kitchen_scene_all_off` - Everything off
- `input_select.kitchen_lighting_scene` - Current scene state

**Tablet Automations**:
- `kitchen_tablet_brightness_schedule` - 80% day, 50% evening, 20% night
- `kitchen_tablet_doorbell_popup` - Wake + alert on doorbell
- `kitchen_tablet_motion_wake` - Wake on kitchen motion
- `kitchen_tablet_sleep_inactivity` - Sleep after 5min idle

### Fully Kiosk Integration Entities
- `switch.kitchen_wall_a9_tablet_screen` - Screen on/off
- `switch.kitchen_wall_a9_tablet_screensaver`
- `switch.kitchen_wall_a9_tablet_kiosk_lock`
- `switch.kitchen_wall_a9_tablet_motion_detection`
- `number.kitchen_wall_a9_tablet_screen_brightness`
- `button.kitchen_wall_a9_tablet_load_start_url`
- `sensor.kitchen_wall_a9_tablet_battery`
- `binary_sensor.kitchen_wall_a9_tablet_plugged_in`

### Dashboard File
**Location**: `/config/dashboards/lovelace-kitchen-tablet.yaml`
**Registered in**: `/config/configuration.yaml` under `lovelace.dashboards`

### Dashboard Components
- Weather card (weather.forecast_home)
- Who's home chip (sensor.people_home_list)
- Calendar (calendar.alaina_and_ella) - Atomic Calendar Revive
- Lighting scene buttons (4x Mushroom template cards)
- Sonos Beam media player (media_player.kitchen_sonos_beam)
- Climate controls (kitchen_mini_split, 1st_floor_thermostat)

### Trusted Networks Auth
Added to configuration.yaml for tablet auto-login:
```yaml
auth:
  auth_providers:
    - type: trusted_networks
      trusted_networks:
        - 192.168.21.0/24
        - 192.168.1.0/24
      allow_bypass_login: true
    - type: homeassistant
```

### Best Practices Applied (2025 Community Standards)
1. **Touch targets**: 56px+ for buttons
2. **Mushroom Cards**: Modern, touch-optimized
3. **Vertical-stack layout**: Simple, reliable
4. **Kiosk Mode**: Available via HACS (hide header/sidebar)
5. **Atomic Calendar Revive**: Multi-calendar support
6. **Conditional content**: Based on presence templates

### Tablet Dashboard Template Pattern
For future tablets, replicate this pattern:
1. Create package: `/config/packages/{location}_tablet_dashboard.yaml`
2. Create dashboard: `/config/dashboards/lovelace-{location}-tablet.yaml`
3. Register in configuration.yaml under lovelace.dashboards
4. Set Fully Kiosk Start URL to: `http://192.168.1.3:8123/lovelace-{location}-tablet/home`
5. Add tablet IP to trusted_networks if not in existing CIDR

### Known Issues / TODO
- **Presence logic**: Currently uses person entities; should use AP-based presence for accuracy
- **Michelle shows "home"**: Need to refine template to exclude her when at her own house
- **Calendar entity**: Verify `calendar.alaina_and_ella` is correct entity ID
- **Kitchen mini-split**: Showed "Unavailable" - check Kumo Cloud integration

### Doorbells for Popup
- `binary_sensor.very_front_door_doorbell` (G4 Doorbell)
- `binary_sensor.front_driveway_door_doorbell` (G4 Doorbell)
- Both have package detection capability

### Related Files
- `/config/packages/kitchen_tablet_dashboard.yaml` - Main package
- `/config/dashboards/lovelace-kitchen-tablet.yaml` - Dashboard YAML
- `/config/automations/tablet_power.yaml` - Away/arrival power
- `/config/automations/kitchen_tablet_wake.yaml` - Wake triggers

### Tablet Authentication - Final Solution

**Dashboard User Credentials:**
- Username: `dashboardtablet2026`
- Password: `dashboarduser`
- Group: Users (non-admin)
- Local access only: Yes

**Why Trusted Networks Auth Failed:**
- HA behind Cloudflare Tunnel (cloudflared)
- `use_x_forwarded_for: true` with `trusted_proxies` for Cloudflare
- Local connections still get intercepted/proxied
- Trusted networks sees wrong source IP

**Best Practice for Fully Kiosk Tablets:**
1. Create dedicated local-only user (non-admin)
2. Simple memorable password (local network only)
3. Log in manually once on tablet
4. Session persists in Fully Kiosk browser
5. Enable "Keep me logged in" on login

**Fully Kiosk Settings for Session Persistence:**
- Settings â†’ Advanced Web Settings â†’ Accept Cookies: ON
- Settings â†’ Advanced Web Settings â†’ Clear Cookies on Exit: OFF
- Settings â†’ Web Auto Reload â†’ Reload on Network Reconnect: ON

**Future Tablet Template:**
1. Reserve DHCP by MAC in UniFi
2. Install Fully Kiosk Browser (PLUS license recommended)
3. Set Start URL: `http://192.168.1.3:8123/lovelace-{location}-tablet/home`
4. Create dashboard YAML in `/config/dashboards/`
5. Register dashboard in configuration.yaml
6. Create/use dashboard user for login
7. Log in once manually - session persists

**Network Note:**
- Tablets on IoT VLAN (192.168.21.x) can reach HA on Default (192.168.1.3)
- Cross-VLAN routing must be enabled in UniFi
- Use IP address, not hostname, for reliability
- 16:56: Kitchen tablet dashboard: layout-card/grid-layout causes red error circle on Fully Kiosk tablets - use vertical-stack + horizontal-stack instead. Tablet entity: notify.mobile_app_kitchen_samsung_tablet_wall_mount (HA Companion) and button.kitchen_wall_a9_tablet_* (Fully Kiosk integration). Kiosk mode needs ?kiosk URL param or admin:true for admin users.
- 19:20: Kitchen tablet automation fix: configuration.yaml was using single file include but automation files were in automations/ directory. Fixed by changing to include_dir_merge_list automations/ and moving automations.yaml to automations/ui_automations.yaml. Tablet wake automation uses binary_sensor.kitchen_motion + person home condition.
- 19:20: Kitchen tablet dashboard rebuild: Created scripts.yaml with kitchen_scene_cooking_bright, kitchen_scene_dinner_dim, kitchen_scene_movie_night, kitchen_scene_all_off, plus music scripts (kitchen_play_chill, kitchen_play_dinner, kitchen_play_kids, kitchen_sonos_stop). Dashboard uses verified entity IDs, added music quick-play buttons, streamlined layout.
- 19:20: Best practice automation directory structure: use include_dir_merge_list automations/ to load all YAML files from directory. Allows organized file-per-automation approach while keeping UI automations in automations/ui_automations.yaml

- 09:33: Consolidated 2nd floor lighting: Replaced 3 automations (night_path_upstairs_hallway, night_path_2nd_floor_bathroom, morning_wake_upstairs_hallway) with 2 clean automations: upstairs_hallway_motion_lighting (all time contexts, deep red at night, adaptive handoff day) and 2nd_floor_bathroom_night_lighting (night only, triggered by hallway P1, shower-safe 15min timeout). Disabled morning_wake_master_bedroom in UI. Lines 505 and 570 in occupancy_system.yaml.

## Family Activities System - Built 2026-01-23

### New Package: `packages/family_activities.yaml`

**Purpose:** Context-aware activity tracking for lighting and automation decisions using calendar + location fusion.

**Components Created:**

#### Zones
- `zone.bagc_gymnastics` - Alaina's gymnastics (20256 W Mill Rd, Galesville, WI)

#### Grade Tracking (auto-increments Aug 15)
- `input_number.ella_grade` - Currently 6
- `input_number.alaina_grade` - Currently 8
- `input_number.jarrett_grade` - Placeholder (3)
- `input_number.owen_grade` - Placeholder (1)

#### Activity Detection (Calendar + Location Fusion)
- `binary_sensor.ella_at_activity` - True when: not home + not school + any calendar active
- `binary_sensor.alaina_at_activity` - True when: at BAGC zone OR (not home + not school + calendar active)

#### Arrival & Time Tracking
- `input_datetime.ella_last_arrived_home` / `alaina_last_arrived_home`
- `sensor.ella_minutes_since_home` / `alaina_minutes_since_home`

#### Late Activity Detection
- `binary_sensor.ella_had_late_activity` - Had activity AND arrived home after 7pm
- `binary_sensor.alaina_had_late_activity`

#### Wind-down Logic
- `binary_sensor.ella_winddown_active` / `alaina_winddown_active`
- Logic: School tomorrow + at home + (9pm OR 90min after late arrival)
- Override: `input_boolean.ella_winddown_override` / `alaina_winddown_override`

#### Automations
- `family_ella_arrived_home` / `family_alaina_arrived_home` - Track arrival times
- `family_ella_left_for_activity` / `family_alaina_left_for_activity` - Set activity flags
- `family_daily_reset` - Clear flags at 4am
- `family_increment_grades` - Auto-increment grades Aug 15

### Calendar Entities Used
**Ella:**
- `calendar.12s_1` - Tenacity 12s-1 volleyball
- `calendar.whitehall_6th_grade_volleyball` - School volleyball
- `calendar.6th_grade_girls_basketball` - School basketball (ended)

**Alaina:**
- `calendar.14s_2` - Tenacity 14s-2 (practice only, no games)
- `calendar.whitehall_middle_school_volleyball_calendar` - School volleyball
- `calendar.bagc_maga_team_1_2_calendar` - BAGC gymnastics (final season)

### Key Design Decisions
1. **Calendar + Location Fusion** - Combines "not home" + "calendar event active" for reliable activity detection even without precise GPS zones for every venue
2. **Late Activity = 7pm+** - Arriving home after 7pm with activity flag triggers 90-min delayed wind-down instead of fixed 9pm
3. **Lights only (silent)** - Wind-down triggers lighting changes without phone notifications
4. **Grade-based logic** - Age divisions (12U, 14U) and school levels (elementary, middle, high) derived from grade

### Future Enhancements (Phase 2)
- [ ] Connect wind-down sensors to kids_bedroom_automation.yaml
- [ ] Add WAYA softball calendars when season starts
- [ ] Seasonal sport active flags
- [ ] Dashboard card for family activities visibility

### Notes
- Alaina's Tenacity 14s-2: Practice only, no tournaments (still triggers activity detection)
- Alaina's BAGC gymnastics: Final season
- Alaina's softball: Last year of 14U
- Ella's softball: 12U this year, then 2 years of 14U

---

## HAC v7.3 Architecture Proposal - Tabled for Future Session

### Problem Statement
Current HAC treats all LLM sessions the same. Reality:
- **Claude Web** (claude.ai): No MCP, has web search, memory system
- **Claude Desktop + MCP**: Direct HA access, privacy concerns, powerful but risky
- **Gemini Pro**: Different strengths (long context, coding), no MCP

### Proposed Features

#### 1. Dynamic Tabled/Learnings Management
- `hac table add "project"` - Add with auto-timestamp
- `hac table done 3` - Mark item #3 complete with rationale
- `hac table priority 2` - Bump item to top
- `hac learn` should auto-categorize (bugfix, feature, pattern, gotcha)
- Learnings should have TTL - archive old ones automatically

#### 2. LLM-Specific Session Prompts
```
hac q              # Default (Claude web) - current behavior
hac q --gemini     # Gemini-optimized (coding focus, longer context)
hac q --mcp        # Claude Desktop with MCP (guided, safety rules)
hac q --minimal    # Token-efficient mode (just essentials)
```

#### 3. MCP-Aware Mode (`hac q --mcp`)
When MCP is active, Claude can directly query HA. Rules needed:
- READ operations: Always allowed (states, entities, logs)
- WRITE operations: Require explicit approval workflow
- Privacy: Never expose tokens, coords, sensitive entities in responses
- Guided workflow: "Use `ha state get sensor.x` instead of asking user to paste"

Output should include:
```
MCP AVAILABLE - Direct HA access enabled
Safe queries: ha state get <entity>, ha service list, ha log tail
Require approval: ha service call, ha config reload
Privacy: Coords/tokens auto-redacted in responses
```

#### 4. Non-MCP Fallback Mode (`hac q --minimal`)
For token efficiency when MCP not needed:
- Skip tabled projects
- Skip learnings summary  
- Just: gist URLs + core rules
- Use when: quick questions, non-HA work, context already established

#### 5. Strategic Workflow Guidance
Each mode should guide the LLM to optimal behavior:

**Coding mode** (Gemini Pro):
- Emphasize: Full file context, type hints, error handling
- De-emphasize: Conversational back-and-forth

**Config mode** (Claude + MCP):
- Emphasize: Safety, backups, validation
- Workflow: propose → approve → execute → verify

**Research mode** (Claude Web):
- Emphasize: Web search for current info, documentation links
- De-emphasize: Direct execution

### Privacy & Security Enhancements
- `hac audit --strict` - Check for coords, MACs, IPs, names
- MCP mode should have allowlist of safe entity patterns
- Sensitive entities list: `person.*`, `device_tracker.*`, `zone.*`

### Implementation Priority
1. [ ] `hac q --mcp` with safety rules (highest value)
2. [ ] Dynamic tabled management (done/priority)
3. [ ] `hac q --gemini` coding optimization
4. [ ] `hac q --minimal` token efficiency
5. [ ] Auto-archive old learnings


### LLM Platform Strategy (Paid Subscriptions: Claude, ChatGPT, Gemini)

#### Claude (claude.ai / Claude Desktop)
**Strengths:** Nuanced reasoning, safety-conscious, artifacts, MCP integration
**Best for HA:** Config editing, automation logic, complex troubleshooting
**Modes:**
- `hac q` - Web interface, memory system, web search
- `hac q --mcp` - Desktop with direct HA access (most powerful, needs guardrails)

#### ChatGPT (GPT-4o / GPT-4)
**Strengths:** Broad knowledge, good at code generation, canvas for editing
**Best for HA:** Dashboard YAML generation, Jinja2 templates, quick lookups
**Mode:** `hac q --gpt`
- Emphasize: Paste-friendly output, self-contained code blocks
- Include: Entity naming conventions, your template patterns
- Skip: MCP references (not available)

#### Gemini Pro (1.5/2.0)
**Strengths:** Massive context window (1M+ tokens), strong coding, fast
**Best for HA:** Full package review, multi-file refactoring, large YAML analysis
**Mode:** `hac q --gemini`
- Emphasize: "Here's the full file, analyze thoroughly"
- Can handle: Multiple packages at once, full system context
- Skip: Interactive back-and-forth (optimize for single comprehensive response)

### Use Case Decision Matrix

| Task | Primary LLM | Reason |
|------|-------------|--------|
| Live debugging with HA access | Claude Desktop + MCP | Direct state queries |
| New automation design | Claude Web | Reasoning + web search for docs |
| Dashboard YAML bulk generation | ChatGPT | Canvas editing, fast iteration |
| Full system audit | Gemini Pro | 1M context, entire config at once |
| Complex Jinja2 templates | ChatGPT or Gemini | Strong at code patterns |
| Troubleshooting unknown issues | Claude Web | Web search + reasoning |
| Privacy-sensitive work | Claude Web (no MCP) | No direct HA exposure |

### Session Handoff Protocol
When switching LLMs mid-project:
1. `hac learn "switching to [LLM] for [reason]"`
2. `hac push` to sync latest state
3. Use appropriate `hac q --[mode]` for new session
4. New LLM fetches gist, sees tabled projects, continues

### Proposed Command Summary
```
hac q              # Claude Web (default)
hac q --mcp        # Claude Desktop + MCP (guided safety)
hac q --gpt        # ChatGPT optimized
hac q --gemini     # Gemini Pro (full context mode)
hac q --minimal    # Any LLM, token-efficient
```

---

## Infrastructure Context (for LLM awareness)

### Network & Hardware Stack
- **Network:** Ubiquiti UniFi (Dream Machine Pro based on previous AP references)
- **Cameras:** UniFi Protect camera system
- **NAS:** Synology (target for Google Drive sync, backup storage)
- **HA Hardware:** Home Assistant Green

### Integration Points with HA
- **UniFi Network:** AP-based presence detection (MAC address tracking per floor)
  - `sensor.ella_ap_location` / `sensor.alaina_ap_location`
  - APs: 2nd_floor_ap, 1st_floor_ap, garage_ap
- **UniFi Protect:** Camera entities, motion detection potential
- **Synology:** Target for `hac push` Google Drive sync (SSH key auth pending)

### Tabled Infrastructure Projects
- SSH key auth to Synology for automated backups
- Potential: UniFi Protect motion → HA automation triggers
- Potential: NAS-based backup rotation for HA snapshots


---

## Additional Context from Session History

### Family & Household
- **John:** RN at TCHCC (5-week rotation), runs Pigeon Falls Lawn Care/Snow Removal LLC and Pigeon Falls Properties LLC (rentals), Village of Pigeon Falls board member, Lions Club
- **Daughters:** Alaina (8th grade, 13-14yo), Ella (6th grade, 11-12yo) - both at Whitehall School
- **Significant Other:** Michelle (lives nearby at 40062 US Hwy 53), sons Jarrett (3rd grade) and Owen (1st grade)
- **Location:** 40154 Hwy 53, Strum, Wisconsin

### Calendar IDs (Critical for Automations)
- **Alaina & Ella shared:** `2emio1oov9oq9u9115lv5oa05c@group.calendar.google.com`
- **John personal (default):** `pigeonfallsrn@gmail.com`
- **John/Michelle:** `2aa2d81010ff6a637e674c2cd23eb3e7a80e9dd48e8e30c50d6784c3cab86043@group.calendar.google.com`
- **Work (RN shifts):** `8249v7qv8g2m6bjc8v37f78gs0@group.calendar.google.com`
- **Lions Club:** `333e072f891daea9a8ffaba89d8e67fb16e89b74fe0a5cc06ad9e1be2e2d5edf@group.calendar.google.com`
- **Whitehall School District:** `whitehallsd.k12.wi.us_41kjiv753u9in6kiefc3rh3t6k@group.calendar.google.com`

### Smart Home Philosophy
- **Local control preferred** over cloud dependencies
- **Token-efficient workflows** - minimize API calls, chain commands
- **Privacy-conscious** - sanitize coords, MACs, tokens in exports
- **Systematic documentation** - learnings, backups before edits

### Key Zones Defined
- `zone.home` (40154 Hwy 53)
- `zone.michelles_house` (40062 US Hwy 53)
- `zone.whitehall_school`
- `zone.tchcc` (John's work)
- `zone.bagc_gymnastics` (Alaina's gymnastics - created this session)

### Device Ecosystem
- **Lighting:** Philips Hue, Inovelli switches, Govee lamps, Aqara sensors
- **Climate:** Nest thermostats, Mitsubishi mini-splits (Kumo Cloud)
- **Voice:** Amazon Echo devices throughout
- **Tablets:** Kitchen wall tablet (Fully Kiosk), Ella's Fire tablet
- **Garage:** ratgdo controllers (2x), Aqara motion sensors

### Automation Patterns Established
- **Presence:** Multi-method (WiFi AP + GPS + Motion)
- **Lighting:** Adaptive lighting with manual override detection
- **Bedtime:** Context-aware wind-down (new family_activities system)
- **Notifications:** Actionable mobile notifications with response handling

### HAC Workflow Preferences
- Terminal commands only, no GUI
- Chain with `&&` for efficiency
- `hac backup` before any edit
- Propose → approve → execute pattern
- `hac learn` to capture insights


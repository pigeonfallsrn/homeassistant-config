# HAC Learnings - 2026-02-05

## Motion Sensor Entity Discovery
- Hue "motion light sensors" (e.g., `light.garage_south_wall_motion_light_sensor`) do NOT expose motion as binary_sensor entities - they handle motion internally in Hue bridge
- Only actual motion sensors in garage: `binary_sensor.garage_north_wall_nightlight_motion`, `binary_sensor.ratgdo32disco_fd8d8c_motion`, `binary_sensor.ratgdo32disco_5735e8_motion`
- Always verify entity existence before using in templates - non-existent entities cause `is_state()` to return false, breaking AND logic

## Notify Service Names
- Correct service: `notify.mobile_app_john_s_phone`
- Wrong/non-existent: `notify.mobile_app_johns_galaxy_s24_ultra`
- Always verify with: `curl ... /api/services | grep notify`

## Template Null Safety
- `states('sensor.x') | default('')` does NOT protect against None when sensor is unavailable
- Use `| default('', true)` for stricter default, OR add explicit null check before operations
- For string slicing: `{% if bssid and bssid[:8] in [...] %}` prevents TypeError on None

## Presence Detection Issues
- GPS-based presence (`person.john_spencer`) requires phone companion app to actively report location changes
- If phone goes to sleep or battery optimization kicks in, departure may not register
- UniFi device_tracker shows connection but doesn't track GPS location
- Alternative triggers: garage door state, vehicle detection, WiFi BSSID changes

## HA Companion App - Essential Sensors for Presence
Enable in app: Settings → Companion App → Manage Sensors
- **Background Location** - core presence tracking (1-3 min updates)
- **Location Zone** - triggers on zone enter/leave
- **Single Accurate Location** - precise on-demand location
- **High Accuracy Mode** - faster updates
- Set **Sensor Update Frequency** to "Fast Always" (1 min vs 15 min)
- Android: Settings → Apps → Home Assistant → Battery → Unrestricted

## API/CLI Notes
- `ha automation reload` doesn't exist - use REST API: `curl -X POST ... /api/services/automation/reload`
- 502 Bad Gateway from supervisor API = HA core is down/restarting
- Template reload: `curl -X POST ... /api/services/template/reload`

## Automation File Organization
- `!include_dir_merge_list automations/` auto-includes all .yaml files in automations/
- New files are picked up on automation reload without config changes
- File naming: descriptive (e.g., `garage_door_notifications.yaml`, `exterior_lights_auto_off.yaml`)

## Aqara Door Sensors
- `binary_sensor.aqara_door_and_window_sensor_door_5` = North garage door (device_class: garage_door)
- `binary_sensor.aqara_door_and_window_sensor_door_6` = South garage door
- State: `off` = closed, `on` = open
- Faster/more reliable than ratgdo tilt sensor for "closed" detection

## Git Maintenance
- `git fsck --full && git gc --prune=now` fixes "confused by unstable object source" errors
- Always exclude: `zigbee.db*`, `.ha_run.lock`
- 09:20: QUICK WINS COMPLETE: (1) Gist pushed, (2) Verified 5 orphan automations - 4 already gone, removed 2 garage_all_lights_off from entity registry, (3) Tabled projects cleaned. Next priority: legacy template audit for 2026.6 deprecation.
- 09:59: Orphan cleanup complete: removed 2 true orphans. Remaining garage_all_lights_off is legit (unique_id: garage_master_lights_off from garage_lighting_automation.yaml). HA regenerated it on restart.
- 10:47: PHASE 2-4 COMPLETE: Fixed duplicate YAML keys in kitchen_tablet_dashboard.yaml, presence_system.yaml, configuration.yaml. Removed duplicate unique_ids (alaina_at_moms etc). Added round() defaults. Moved 29 old .bak files to hac/backups/old_package_baks/. All configs validated.
- 11:47: HARDWARE CHANGE 2026-02-05: 1st Floor Bathroom - TP-Link dimmer installed for vanity lights, replaces Inovelli. Old Inovelli will move to 2nd Floor Bathroom (smart bulb mode). ISSUE: Remaining 1st FL Bathroom Inovelli (ceiling) not controlling Hue lights properly - needs Smart Bulb Mode check.
- 12:02: 1ST FL BATHROOM INOVELLI+HUE SETUP: (1) Enable Smart Bulb Mode via ZHA Manage Clusters → Inovelli_VZM31SN_Cluster → attribute 'Smart Bulb Mode' = 1. (2) Create automation using fxlt blueprint 'Inovelli VZM31-SN Blue Series 2-1 Switch (ZHA)'. (3) Map paddle presses to light.1st_floor_bathroom (Hue group). (4) Set automation mode: queued. This routes Inovelli→ZHA→HA→Hue Bridge→Hue Bulbs since direct Zigbee binding not possible across different coordinators.
- 21:02: 1ST FL BATHROOM INOVELLI WORKING: Key issue was automations.yaml being ignored - config uses include_dir_merge_list automations/ so automations must go in automations/ directory. Created automations/1st_floor_bathroom_inovelli.yaml using fxlt blueprint.

# Motion Aggregation - Room-Level Occupancy Sensors
# Combines P1 (fast) + Third Reality (motion+lux) per room
# Created: 2026-01-20
# Updated: 2026-01-22 - Added Living Room TR sensors + Lux sensors

template:
  - binary_sensor:
      # -----------------------------------------------------------------
      # Entry Room - Combined Motion
      # -----------------------------------------------------------------
      - name: "Entry Room Motion"
        unique_id: entry_room_motion_combined
        device_class: motion
        state: >
          {{ is_state('binary_sensor.entry_room_east_wall_nightlight_motion', 'on')
             or is_state('binary_sensor.entry_room_west_wall_nightlight_motion', 'on') }}
        delay_off:
          seconds: 30

      # -----------------------------------------------------------------
      # Kitchen Lounge - Combined Motion (P1 + TR)
      # -----------------------------------------------------------------
      - name: "Kitchen Lounge Motion"
        unique_id: kitchen_lounge_motion_combined
        device_class: motion
        state: >
          {{ is_state('binary_sensor.aqara_motion_sensor_p1_occupancy', 'on')
             or is_state('binary_sensor.kitchen_lounge_east_wall_night_light_motion', 'on')
             or is_state('binary_sensor.kitchen_lounge_east_wall_nightlight_motion', 'on') }}
        delay_off:
          seconds: 30

      # -----------------------------------------------------------------
      # Kitchen - Combined Motion
      # -----------------------------------------------------------------
      - name: "Kitchen Motion"
        unique_id: kitchen_motion_combined
        device_class: motion
        state: >
          {{ is_state('binary_sensor.kitchen_counter_nightlight_motion', 'on')
             or is_state('binary_sensor.kitchen_counter_night_light_motion', 'on')
             or is_state('binary_sensor.kitchen_west_wall_nightlight_motion', 'on') }}
        delay_off:
          seconds: 30

      # -----------------------------------------------------------------
      # 1st Floor Bathroom Hallway - P1 + Bathroom TR
      # -----------------------------------------------------------------
      - name: "1st Floor Bathroom Hallway Motion"
        unique_id: 1st_floor_bath_hallway_motion_combined
        device_class: motion
        state: >
          {{ is_state('binary_sensor.aqara_motion_sensor_p1_occupancy_3', 'on')
             or is_state('binary_sensor.1st_floor_bathroom_night_light_motion', 'on') }}
        delay_off:
          seconds: 30

      # -----------------------------------------------------------------
      # Front Door Hallway / Stairs - P1
      # -----------------------------------------------------------------
      - name: "Front Door Hallway Motion"
        unique_id: front_door_hallway_motion_combined
        device_class: motion
        state: >
          {{ is_state('binary_sensor.aqara_motion_sensor_p1_occupancy_6', 'on')
             or is_state('binary_sensor.very_front_door_motion_sensor_occupancy', 'on') }}
        delay_off:
          seconds: 30

      # -----------------------------------------------------------------
      # Upstairs Hallway - P1 + TR
      # -----------------------------------------------------------------
      - name: "Upstairs Hallway Motion"
        unique_id: upstairs_hallway_motion_combined
        device_class: motion
        state: >
          {{ is_state('binary_sensor.aqara_motion_sensor_p1_occupancy_2', 'on')
             or is_state('binary_sensor.upstairs_hallway_night_light_motion', 'on')
             or is_state('binary_sensor.upstairs_hallway_east_wall_night_light_motion', 'on') }}
        delay_off:
          seconds: 30

      # -----------------------------------------------------------------
      # Upstairs Bathroom - TR only
      # -----------------------------------------------------------------
      - name: "Upstairs Bathroom Motion"
        unique_id: upstairs_bathroom_motion_combined
        device_class: motion
        state: >
          {{ is_state('binary_sensor.upstairs_bathroom_night_light_motion', 'on') }}
        delay_off:
          seconds: 30

      # -----------------------------------------------------------------
      # Living Room - TR East + West + motionaware fallback
      # -----------------------------------------------------------------
      - name: "Living Room Motion"
        unique_id: living_room_motion_combined
        device_class: motion
        state: >
          {{ is_state('binary_sensor.living_room_north_wall_west_nightlight_motion', 'on')
             or is_state('binary_sensor.living_room_north_wall_east_nightlight_motion', 'on')
             or is_state('binary_sensor.living_rm_loungemotionaware_area', 'on') }}
        delay_off:
          seconds: 30

      # -----------------------------------------------------------------
      # Downstairs - Any motion on first floor
      # -----------------------------------------------------------------
      - name: "Downstairs Motion"
        unique_id: downstairs_motion_any
        device_class: motion
        state: >
          {{ is_state('binary_sensor.entry_room_motion', 'on')
             or is_state('binary_sensor.kitchen_lounge_motion', 'on')
             or is_state('binary_sensor.kitchen_motion', 'on')
             or is_state('binary_sensor.1st_floor_bathroom_hallway_motion', 'on')
             or is_state('binary_sensor.front_door_hallway_motion', 'on')
             or is_state('binary_sensor.living_room_motion', 'on') }}

      # -----------------------------------------------------------------
      # Upstairs - Any motion on second floor
      # -----------------------------------------------------------------
      - name: "Upstairs Motion"
        unique_id: upstairs_motion_any
        device_class: motion
        state: >
          {{ is_state('binary_sensor.upstairs_hallway_motion', 'on')
             or is_state('binary_sensor.upstairs_bathroom_motion', 'on')
             or is_state('binary_sensor.upstairs_motionaware_area', 'on') }}

      # -----------------------------------------------------------------
      # Whole House - Any motion anywhere
      # -----------------------------------------------------------------
      - name: "House Motion Any"
        unique_id: house_motion_any
        device_class: motion
        state: >
          {{ is_state('binary_sensor.downstairs_motion', 'on')
             or is_state('binary_sensor.upstairs_motion', 'on')
             or is_state('binary_sensor.basement_hallway_motion_sensor_occupancy', 'on') }}

  # ===================================================================
  # LUX SENSORS - Room Averages
  # ===================================================================
  - sensor:
      # -----------------------------------------------------------------
      # Living Room - Average Lux
      # -----------------------------------------------------------------
      - name: "Living Room Average Lux"
        unique_id: living_room_average_lux
        unit_of_measurement: lx
        device_class: illuminance
        state: >
          {% set west = states('sensor.living_room_north_wall_west_nightlight_illuminance') | float(0) %}
          {% set east = states('sensor.living_room_north_wall_east_nightlight_illuminance') | float(0) %}
          {{ ((west + east) / 2) | round(1) }}

      # -----------------------------------------------------------------
      # Kitchen Lounge - Average Lux
      # -----------------------------------------------------------------
      - name: "Kitchen Lounge Average Lux"
        unique_id: kitchen_lounge_average_lux
        unit_of_measurement: lx
        device_class: illuminance
        state: >
          {{ states('sensor.kitchen_lounge_east_wall_night_light_illuminance') | float(0) | round(1) }}

# ============================================================================
# Garage Lighting Automation
# Updated: 2026-01-25
# FIX: Changed OFF trigger to use template that checks ALL motion sensors
# ============================================================================

automation:
  # === LIGHTS ON ===
  - id: garage_master_lights_on
    alias: "Garage All Lights ON"
    trigger:
      - platform: state
        entity_id: cover.ratgdo32disco_fd8d8c_door
        to: 'open'
      - platform: state
        entity_id: cover.ratgdo32disco_5735e8_door
        to: 'open'
      - platform: state
        entity_id: binary_sensor.aqara_door_and_window_sensor_door_3
        to: 'on'
      - platform: state
        entity_id: binary_sensor.ratgdo32disco_fd8d8c_motion
        to: 'on'
      - platform: state
        entity_id: binary_sensor.ratgdo32disco_5735e8_motion
        to: 'on'
    action:
      - service: light.turn_on
        target:
          entity_id:
            - light.garage
            - light.ratgdo32disco_fd8d8c_light
            - light.garage_north_wall_nightlight
            - light.garage_north_of_east_wall_motion_light_sensor
            - light.garage_south_of_east_wall_motion_light_sensor
            - light.garage_south_wall_motion_light_sensor
        data:
          brightness_pct: 100
    mode: restart

  # === LIGHTS OFF - Fixed trigger logic ===
  - id: garage_master_lights_off
    alias: "Garage All Lights OFF"
    trigger:
      # Trigger every minute to check conditions
      - platform: state
        entity_id:
          - binary_sensor.ratgdo32disco_fd8d8c_motion
          - binary_sensor.ratgdo32disco_5735e8_motion
        to: 'off'
        for:
          minutes: 6
    condition:
      # ALL conditions must be true
      - condition: state
        entity_id: cover.ratgdo32disco_fd8d8c_door
        state: 'closed'
      - condition: state
        entity_id: cover.ratgdo32disco_5735e8_door
        state: 'closed'
      - condition: state
        entity_id: binary_sensor.ratgdo32disco_fd8d8c_motion
        state: 'off'
        for:
          minutes: 6
      - condition: state
        entity_id: binary_sensor.ratgdo32disco_5735e8_motion
        state: 'off'
        for:
          minutes: 6
    action:
      - service: light.turn_off
        target:
          entity_id:
            - light.garage
            - light.ratgdo32disco_fd8d8c_light
            - light.garage_north_wall_nightlight
            - light.garage_north_of_east_wall_motion_light_sensor
            - light.garage_south_of_east_wall_motion_light_sensor
            - light.garage_south_wall_motion_light_sensor
    mode: restart

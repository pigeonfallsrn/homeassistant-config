# Kitchen Lounge Lamp - Adaptive Lighting with Lux + Presence + Time Awareness

# =============================================================================
# HELPERS
# =============================================================================

input_boolean:
  kitchen_lounge_manual_override:
    name: Kitchen Lounge Manual Override
    initial: false

input_number:
  kitchen_lounge_lux_threshold:
    name: Kitchen Lounge Lux Threshold
    min: 10
    max: 200
    step: 10
    initial: 50
    unit_of_measurement: lux
    icon: mdi:brightness-5

template:
  - sensor:
      - name: "Kitchen Lounge Average Lux"
        unique_id: kitchen_lounge_average_lux
        unit_of_measurement: lux
        device_class: illuminance
        state: >
          {% set s1 = states('sensor.kitchen_lounge_east_wall_night_light_illuminance') | float(0) %}
          {% set s2 = states('sensor.kitchen_lounge_east_wall_nightlight_illuminance') | float(0) %}
          {% if s1 > 0 and s2 > 0 %}
            {{ ((s1 + s2) / 2) | round(1) }}
          {% elif s1 > 0 %}
            {{ s1 }}
          {% else %}
            {{ s2 }}
          {% endif %}

# =============================================================================
# AUTOMATIONS
# =============================================================================

automation:
  # ---------------------------------------------------------------------------
  # Kitchen Lounge Lamp - Lux-Gated Adaptive Control
  # ---------------------------------------------------------------------------
  - id: kitchen_lounge_lamp_adaptive_control
    alias: "Kitchen Lounge Lamp - Adaptive Lux Control"
    description: "Manages lamp based on lux, presence, time, and modes"
    mode: single
    trigger:
      - platform: numeric_state
        entity_id: sensor.kitchen_lounge_average_lux
        below: input_number.kitchen_lounge_lux_threshold
        for:
          seconds: 30
        id: dark_enough
      - platform: numeric_state
        entity_id: sensor.kitchen_lounge_average_lux
        above: 150
        for:
          seconds: 30
        id: too_bright
      - platform: state
        entity_id: binary_sensor.kitchen_lounge_motion
        to: "on"
        for:
          seconds: 2
        id: motion
      - platform: state
        entity_id: input_boolean.hot_tub_mode
        id: hot_tub_toggle
      - platform: state
        entity_id: input_boolean.dad_bedtime_mode
        to: "on"
        id: bedtime_on
    condition:
      - condition: state
        entity_id: input_boolean.kitchen_lounge_manual_override
        state: "off"
      # Debounce - prevent double-trigger from multiple motion sensors
      - condition: template
        value_template: >-
          {{ (as_timestamp(now()) - as_timestamp(state_attr('automation.kitchen_lounge_lamp_adaptive_lux_control', 'last_triggered') | default(0))) > 5 }}
      # Mode triggers always pass; motion/lux require light off
      - condition: or
        conditions:
          - condition: trigger
            id: hot_tub_toggle
          - condition: trigger
            id: bedtime_on
          - condition: trigger
            id: too_bright
          - condition: and
            conditions:
              - condition: or
                conditions:
                  - condition: trigger
                    id: motion
                  - condition: trigger
                    id: dark_enough
              - condition: state
                entity_id: light.kitchen_lounge_lamp
                state: "off"
    action:
      - choose:
          # HOT TUB MODE - Deep red, very dim
          - conditions:
              - condition: state
                entity_id: input_boolean.hot_tub_mode
                state: "on"
            sequence:
              - service: light.turn_on
                target:
                  entity_id: light.kitchen_lounge_lamp
                data:
                  rgb_color: [255, 30, 0]
                  brightness_pct: 5
                  transition: 2

          # DAD BEDTIME MODE - Fade off
          - conditions:
              - condition: trigger
                id: bedtime_on
            sequence:
              - service: light.turn_on
                target:
                  entity_id: light.kitchen_lounge_lamp
                data:
                  brightness_pct: 10
                  color_temp_kelvin: 2200
                  transition: 60
              - delay:
                  minutes: 15
              - service: light.turn_off
                target:
                  entity_id: light.kitchen_lounge_lamp
                data:
                  transition: 60

          # ROOM TOO BRIGHT - Fade off
          - conditions:
              - condition: trigger
                id: too_bright
              - condition: state
                entity_id: light.kitchen_lounge_lamp
                state: "on"
            sequence:
              - service: light.turn_off
                target:
                  entity_id: light.kitchen_lounge_lamp
                data:
                  transition: 120

          # ROOM DARK + MOTION - Turn on with appropriate brightness
          - conditions:
              - condition: trigger
                id: motion
              - condition: numeric_state
                entity_id: sensor.kitchen_lounge_average_lux
                below: input_number.kitchen_lounge_lux_threshold
              - condition: state
                entity_id: input_boolean.hot_tub_mode
                state: "off"
              - condition: state
                entity_id: input_boolean.dad_bedtime_mode
                state: "off"
              - condition: or
                conditions:
                  - condition: state
                    entity_id: sun.sun
                    state: "below_horizon"
                  - condition: state
                    entity_id: input_boolean.someone_home
                    state: "on"
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.adaptive_lighting_living_spaces
              - service: light.turn_on
                target:
                  entity_id: light.kitchen_lounge_lamp
                data:
                  brightness_pct: "{{ states('sensor.evening_lamp_max_brightness') | int }}"

          # HOT TUB MODE TURNED OFF - Restore AL control
          - conditions:
              - condition: trigger
                id: hot_tub_toggle
              - condition: state
                entity_id: input_boolean.hot_tub_mode
                state: "off"
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.adaptive_lighting_living_spaces
              - condition: state
                entity_id: light.kitchen_lounge_lamp
                state: "on"
              - service: adaptive_lighting.apply
                data:
                  entity_id: switch.adaptive_lighting_living_spaces
                  lights:
                    - light.kitchen_lounge_lamp
                  transition: 5

  # ---------------------------------------------------------------------------
  # Kitchen Lounge Lamp - No Motion Timeout
  # ---------------------------------------------------------------------------
  - id: kitchen_lounge_lamp_no_motion_dim
    alias: "Kitchen Lounge Lamp - Dim After 15min No Motion"
    trigger:
      - platform: state
        entity_id: binary_sensor.kitchen_lounge_motion
        to: "on"
        to: "off"
        for:
          minutes: 15
    condition:
      - condition: state
        entity_id: light.kitchen_lounge_lamp
        state: "on"
      - condition: numeric_state
        entity_id: light.kitchen_lounge_lamp
        attribute: brightness
        above: 50
    action:
      - service: light.turn_on
        target:
          entity_id: light.kitchen_lounge_lamp
        data:
          brightness_pct: 20
          transition: 60
    mode: single

  - id: kitchen_lounge_lamp_no_motion_off
    alias: "Kitchen Lounge Lamp - Off After 30min No Motion"
    trigger:
      - platform: state
        entity_id: binary_sensor.kitchen_lounge_motion
        to: "on"
        to: "off"
        for:
          minutes: 30
    condition:
      - condition: state
        entity_id: light.kitchen_lounge_lamp
        state: "on"
    action:
      - service: light.turn_off
        target:
          entity_id: light.kitchen_lounge_lamp
        data:
          transition: 60

  # ---------------------------------------------------------------------------
  # Kitchen Lounge Lamp - Hard Off Time
  # ---------------------------------------------------------------------------
  - id: kitchen_lounge_lamp_hard_off
    alias: "Kitchen Lounge Lamp - Hard Off at Evening End"
    trigger:
      - platform: template
        value_template: >
          {{ now().strftime('%H:%M') == states('sensor.evening_lamp_off_time') }}
    condition:
      - condition: state
        entity_id: light.kitchen_lounge_lamp
        state: "on"
      - condition: state
        entity_id: input_boolean.hot_tub_mode
        state: "off"
    action:
      - service: light.turn_off
        target:
          entity_id: light.kitchen_lounge_lamp
        data:
          transition: 120

  # ---------------------------------------------------------------------------
  # Everyone Left - Lamp Off
  # ---------------------------------------------------------------------------
  - id: kitchen_lounge_lamp_everyone_left
    alias: "Kitchen Lounge Lamp - Off When Everyone Leaves"
    trigger:
      - platform: state
        entity_id: input_boolean.someone_home
        to: "off"
    condition:
      - condition: state
        entity_id: light.kitchen_lounge_lamp
        state: "on"
    action:
      - service: light.turn_off
        target:
          entity_id: light.kitchen_lounge_lamp
        data:
          transition: 30

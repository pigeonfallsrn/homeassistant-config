# =============================================================================
# GARAGE QUICK OPEN/CLOSE - v2 (Auto-Open + Auto-Close)
# Replaces manual-only notification with smart auto-open on arrival
# Anti-drive-by: 60s cancel window + distance/WiFi re-check
# Auto-close on departure with 3-min cancel window
# =============================================================================

automation:
  # ===========================================================================
  # AUTO-OPEN: APPROACHING HOME (anti-drive-by with cancel window)
  # Stage 1: Distance < 800m -> notify with 60s cancel window
  # Stage 2: Re-verify still approaching -> auto-open north door
  # ===========================================================================
  - id: garage_auto_open_approaching
    alias: "Garage - Auto Open North on Arrival"
    description: >
      Auto-opens north garage door when approaching home.
      60-second cancel window with drive-by protection.
      Re-verifies proximity/WiFi before opening.
    trigger:
      - platform: numeric_state
        entity_id: sensor.john_distance_to_home
        below: 400
    condition:
      - condition: template
        value_template: "{{ states('person.john_spencer') != 'home' }}"
      - condition: numeric_state
        entity_id: sensor.john_distance_to_home
        above: 50
      - condition: state
        entity_id: cover.ratgdo32disco_fd8d8c_door
        state: "closed"
    action:
      - service: notify.mobile_app_john_s_phone
        data:
          title: "\U0001F697 Welcome Home"
          message: "North garage opening in 30s \u2014 tap to cancel"
          data:
            tag: "garage_auto_open"
            ttl: 0
            priority: high
            importance: high
            channel: alarm_stream
            visibility: public
            timeout: 75
            notification_icon: "mdi:garage-open-variant"
            actions:
              - action: "CANCEL_AUTO_OPEN"
                title: "CANCEL"
              - action: "OPEN_NOW"
                title: "OPEN NOW"
      - wait_for_trigger:
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "CANCEL_AUTO_OPEN"
            id: cancelled
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "OPEN_NOW"
            id: open_now
        timeout:
          seconds: 45
        continue_on_timeout: true
      - if:
          - condition: template
            value_template: "{{ wait.trigger and wait.trigger.id == 'cancelled' }}"
        then:
          - service: notify.mobile_app_john_s_phone
            data:
              message: "clear_notification"
              data:
                tag: "garage_auto_open"
          - stop: "User cancelled auto-open"
      - if:
          - condition: template
            value_template: "{{ wait.trigger and wait.trigger.id == 'open_now' }}"
        then:
          - service: cover.open_cover
            target:
              entity_id: cover.ratgdo32disco_fd8d8c_door
          - service: notify.mobile_app_john_s_phone
            data:
              title: "\U0001F697 Garage"
              message: "North door opening"
              data:
                tag: "garage_auto_open"
                ttl: 0
                timeout: 30
          - stop: "User requested immediate open"
      - condition: or
        conditions:
          - condition: state
            entity_id: sensor.john_s_phone_wi_fi_connection
            state: "Spencer"
          - condition: numeric_state
            entity_id: sensor.john_distance_to_home
            below: 200
          - condition: state
            entity_id: person.john_spencer
            state: "home"
      - condition: state
        entity_id: cover.ratgdo32disco_fd8d8c_door
        state: "closed"
      - service: cover.open_cover
        target:
          entity_id: cover.ratgdo32disco_fd8d8c_door
      - service: notify.mobile_app_john_s_phone
        data:
          title: "\U0001F697 Garage"
          message: "North door opened automatically"
          data:
            tag: "garage_auto_open"
            ttl: 0
            timeout: 30
    mode: single
    max_exceeded: silent

  # ===========================================================================
  # AUTO-OPEN: FALLBACK NOTIFICATION
  # Catches zone-enter when distance trigger missed or was cancelled
  # ===========================================================================
  - id: garage_open_fallback_notification
    alias: "Garage - Arrival Open Fallback Notification"
    trigger:
      - platform: state
        entity_id: person.john_spencer
        to: "home"
    condition:
      - condition: state
        entity_id: cover.ratgdo32disco_fd8d8c_door
        state: "closed"
    action:
      - delay:
          seconds: 5
      - condition: state
        entity_id: cover.ratgdo32disco_fd8d8c_door
        state: "closed"
      - service: notify.mobile_app_john_s_phone
        data:
          title: "\U0001F697 Home"
          message: "Open garage door?"
          data:
            tag: "garage_quick_open"
            ttl: 0
            priority: high
            importance: high
            channel: alarm_stream
            timeout: 180
            notification_icon: "mdi:garage"
            actions:
              - action: "QUICK_OPEN_NORTH"
                title: "NORTH"
              - action: "QUICK_OPEN_SOUTH"
                title: "SOUTH"
              - action: "QUICK_OPEN_BOTH"
                title: "BOTH"
    mode: single

  # ===========================================================================
  # AUTO-CLOSE: DEPARTURE DETECTION
  # Person leaves home + door open -> 3-min cancel window -> close
  # ===========================================================================
  - id: garage_auto_close_departure
    alias: "Garage - Auto Close North on Departure"
    description: >
      Auto-closes north garage door when leaving home.
      3-minute cancel window with notification.
      Cancels if you return home before timer expires.
    trigger:
      - platform: state
        entity_id: person.john_spencer
        from: "home"
        id: left_zone
      - platform: state
        entity_id: sensor.john_s_phone_wi_fi_connection
        from: "Spencer"
        id: wifi_disconnect
    condition:
      - condition: state
        entity_id: cover.ratgdo32disco_fd8d8c_door
        state: "open"
    action:
      - service: notify.mobile_app_john_s_phone
        data:
          title: "\U0001F6AA Garage Still Open"
          message: "North door closing in 60s \u2014 tap to cancel"
          data:
            tag: "garage_auto_close"
            ttl: 0
            priority: high
            importance: high
            channel: alarm_stream
            visibility: public
            notification_icon: "mdi:garage-alert-variant"
            actions:
              - action: "CANCEL_AUTO_CLOSE"
                title: "KEEP OPEN"
              - action: "CLOSE_NOW_DEPART"
                title: "CLOSE NOW"
      - wait_for_trigger:
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "CANCEL_AUTO_CLOSE"
            id: cancelled
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "CLOSE_NOW_DEPART"
            id: close_now
          - platform: state
            entity_id: person.john_spencer
            to: "home"
            id: returned
        timeout:
          seconds: 60
        continue_on_timeout: true
      - if:
          - condition: template
            value_template: "{{ wait.trigger and wait.trigger.id == 'cancelled' }}"
        then:
          - service: notify.mobile_app_john_s_phone
            data:
              message: "clear_notification"
              data:
                tag: "garage_auto_close"
          - stop: "User cancelled auto-close"
      - if:
          - condition: template
            value_template: "{{ wait.trigger and wait.trigger.id == 'returned' }}"
        then:
          - service: notify.mobile_app_john_s_phone
            data:
              title: "\U0001F3E0 Welcome Back"
              message: "Auto-close cancelled \u2014 you returned home"
              data:
                tag: "garage_auto_close"
                ttl: 0
                timeout: 15
          - stop: "User returned home, cancelled auto-close"
      - if:
          - condition: template
            value_template: "{{ wait.trigger and wait.trigger.id == 'close_now' }}"
        then:
          - service: cover.close_cover
            target:
              entity_id: cover.ratgdo32disco_fd8d8c_door
          - service: notify.mobile_app_john_s_phone
            data:
              message: "clear_notification"
              data:
                tag: "garage_auto_close"
          - stop: "User requested immediate close"
      - condition: state
        entity_id: cover.ratgdo32disco_fd8d8c_door
        state: "open"
      - service: cover.close_cover
        target:
          entity_id: cover.ratgdo32disco_fd8d8c_door
      - service: notify.mobile_app_john_s_phone
        data:
          title: "\U0001F512 Garage"
          message: "North door closed automatically"
          data:
            tag: "garage_auto_close"
            ttl: 0
            timeout: 30
    mode: single
    max_exceeded: silent

  # ===========================================================================
  # WALK-IN DOOR TRIGGER (when home, manual open option)
  # ===========================================================================
  - id: garage_quick_open_walkin
    alias: "Garage - Walk-in Door Quick Open"
    trigger:
      - platform: state
        entity_id: binary_sensor.aqara_door_and_window_sensor_door_3
        to: "on"
    condition:
      - condition: state
        entity_id: person.john_spencer
        state: "home"
      - condition: state
        entity_id: cover.ratgdo32disco_fd8d8c_door
        state: "closed"
    action:
      - service: notify.mobile_app_john_s_phone
        data:
          title: "\U0001F697 Garage"
          message: "Open door?"
          data:
            tag: "garage_quick_open"
            ttl: 0
            priority: high
            timeout: 60
            actions:
              - action: "QUICK_OPEN_NORTH"
                title: "NORTH"
              - action: "QUICK_OPEN_SOUTH"
                title: "SOUTH"
    mode: single

  # ===========================================================================
  # ACTION HANDLERS (shared across all open/close flows)
  # ===========================================================================
  - id: garage_quick_open_action_handler
    alias: "Garage - Quick Open Action Handler"
    trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "QUICK_OPEN_NORTH"
        id: north
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "QUICK_OPEN_SOUTH"
        id: south
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "QUICK_OPEN_BOTH"
        id: both
    action:
      - choose:
          - conditions:
              - condition: trigger
                id: north
            sequence:
              - service: cover.open_cover
                target:
                  entity_id: cover.ratgdo32disco_fd8d8c_door
          - conditions:
              - condition: trigger
                id: south
            sequence:
              - service: cover.open_cover
                target:
                  entity_id: cover.ratgdo32disco_5735e8_door
          - conditions:
              - condition: trigger
                id: both
            sequence:
              - service: cover.open_cover
                target:
                  entity_id:
                    - cover.ratgdo32disco_fd8d8c_door
                    - cover.ratgdo32disco_5735e8_door
      - service: notify.mobile_app_john_s_phone
        data:
          message: "clear_notification"
          data:
            tag: "garage_quick_open"
    mode: single

  # ===========================================================================
  # CLEAR NOTIFICATIONS ON STATE CHANGE
  # ===========================================================================
  - id: garage_quick_open_clear
    alias: "Garage - Clear Quick Open When Door Opens"
    trigger:
      - platform: state
        entity_id:
          - cover.ratgdo32disco_fd8d8c_door
          - cover.ratgdo32disco_5735e8_door
        to: "open"
    action:
      - service: notify.mobile_app_john_s_phone
        data:
          message: "clear_notification"
          data:
            tag: "garage_quick_open"
      - service: notify.mobile_app_john_s_phone
        data:
          message: "clear_notification"
          data:
            tag: "garage_auto_open"
    mode: single

  # ===========================================================================
  # ARRIVAL LIGHTS (Night Only)
  # ===========================================================================
  - id: arrival_lights_approaching
    alias: "Arrival - Driveway & Garage Lights When Approaching"
    trigger:
      - platform: numeric_state
        entity_id: sensor.john_distance_to_home
        below: 500
    condition:
      - condition: template
        value_template: "{{ states('person.john_spencer') != 'home' }}"
      - service: light.turn_on
        target:
          entity_id:
            - light.front_driveway
            - light.garage
        data:
          brightness_pct: 100
    mode: single

  # ===========================================================================
  # QUICK CLOSE NOTIFICATIONS (when door opens while home)
  # ===========================================================================
  - id: garage_north_opened_close_option
    alias: "Garage - North Door Opened Close Option"
    trigger:
      - platform: state
        entity_id: cover.ratgdo32disco_fd8d8c_door
        to: "open"
    condition:
      - condition: state
        entity_id: person.john_spencer
        state: "home"
    action:
      - service: notify.mobile_app_john_s_phone
        data:
          title: "\U0001F697 North Door Open"
          message: "Tap to close"
          data:
            tag: "garage_north_close"
            ttl: 0
            priority: high
            timeout: 90
            actions:
              - action: "CLOSE_NORTH_NOW"
                title: "CLOSE DOOR"
    mode: single

  - id: garage_north_close_action
    alias: "Garage - North Close Action Handler"
    trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "CLOSE_NORTH_NOW"
    action:
      - service: cover.close_cover
        target:
          entity_id: cover.ratgdo32disco_fd8d8c_door
      - service: notify.mobile_app_john_s_phone
        data:
          message: "clear_notification"
          data:
            tag: "garage_north_close"
    mode: single

  - id: garage_north_close_clear
    alias: "Garage - Clear North Close When Closed"
    trigger:
      - platform: state
        entity_id: cover.ratgdo32disco_fd8d8c_door
        to: "closed"
    action:
      - service: notify.mobile_app_john_s_phone
        data:
          message: "clear_notification"
          data:
            tag: "garage_north_close"
      - service: notify.mobile_app_john_s_phone
        data:
          message: "clear_notification"
          data:
            tag: "garage_quick_open"
      - service: notify.mobile_app_john_s_phone
        data:
          message: "clear_notification"
          data:
            tag: "garage_auto_close"
    mode: single

  - id: garage_south_opened_close_option
    alias: "Garage - South Door Opened Close Option"
    trigger:
      - platform: state
        entity_id: cover.ratgdo32disco_5735e8_door
        to: "open"
    condition:
      - condition: state
        entity_id: person.john_spencer
        state: "home"
    action:
      - service: notify.mobile_app_john_s_phone
        data:
          title: "\U0001F697 South Door Open"
          message: "Tap to close"
          data:
            tag: "garage_south_close"
            ttl: 0
            priority: high
            timeout: 90
            actions:
              - action: "CLOSE_SOUTH_NOW"
                title: "CLOSE DOOR"
    mode: single

  - id: garage_south_close_action
    alias: "Garage - South Close Action Handler"
    trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "CLOSE_SOUTH_NOW"
    action:
      - service: cover.close_cover
        target:
          entity_id: cover.ratgdo32disco_5735e8_door
      - service: notify.mobile_app_john_s_phone
        data:
          message: "clear_notification"
          data:
            tag: "garage_south_close"
    mode: single

  - id: garage_south_close_clear
    alias: "Garage - Clear South Close When Closed"
    trigger:
      - platform: state
        entity_id: cover.ratgdo32disco_5735e8_door
        to: "closed"
    action:
      - service: notify.mobile_app_john_s_phone
        data:
          message: "clear_notification"
          data:
            tag: "garage_south_close"
    mode: single

  # ===========================================================================

# ═══════════════════════════════════════════════════════════
# Occupancy-Driven Context System
# Ground-up build: Calendar-aware, AL-friendly, best practices
# Created: 2026-01-19
# ═══════════════════════════════════════════════════════════

# ═══════════════════════════════════════════════════════════
# HELPERS (Input Booleans & Selects)
# ═══════════════════════════════════════════════════════════

input_boolean:
  # Calendar-derived states (set by automation)
  school_tomorrow:
    name: "School Tomorrow"
    icon: mdi:school
  
  school_in_session_now:
    name: "School In Session Now"
    icon: mdi:school-outline
  
  kids_expected_away_now:
    name: "Kids Expected Away Now"
    icon: mdi:account-clock
  
  # Overlay states
  preserve_night_vision:
    name: "Preserve Night Vision"
    icon: mdi:brightness-2
  
  guest_present:
    name: "Guest Present"
    icon: mdi:account-supervisor
  
  kids_bedtime_override:
    name: "Kids Bedtime Override"
    icon: mdi:sleep-off

input_select:
  occupancy_mode:
    name: "Occupancy Mode"
    options:
      - "Empty"
      - "John Only"
      - "Kids Only"
      - "John + Kids"
      - "John + Michelle"
      - "Full House"
      - "Mixed"
    icon: mdi:home-account

# ═══════════════════════════════════════════════════════════
# TEMPLATE SENSORS
# ═══════════════════════════════════════════════════════════

template:
  - sensor:
      # Occupancy mode (auto-calculated from presence system)
      - name: "Occupancy Mode Auto"
        unique_id: occupancy_mode_auto
        state: >
          {% set john = is_state('input_boolean.john_home', 'on') %}
          {% set alaina = is_state('input_boolean.alaina_home', 'on') %}
          {% set ella = is_state('input_boolean.ella_home', 'on') %}
          {% set michelle = is_state('input_boolean.michelle_home', 'on') %}
          {% set kids = alaina or ella %}
          {% set both_kids = alaina and ella %}
          
          {% if john and both_kids and michelle %}
            Full House
          {% elif john and both_kids %}
            John + Kids
          {% elif john and michelle %}
            John + Michelle
          {% elif john and kids %}
            John + Kids
          {% elif kids %}
            Kids Only
          {% elif john %}
            John Only
          {% else %}
            Empty
          {% endif %}
        icon: mdi:home-analytics
      
      # Time of day context
      - name: "Time Context"
        unique_id: time_context
        state: >
          {% set hour = now().hour %}
          {% if hour >= 22 or hour < 6 %}
            night
          {% elif hour >= 18 %}
            evening
          {% elif hour >= 12 %}
            afternoon
          {% else %}
            morning
          {% endif %}
        icon: >
          {% set hour = now().hour %}
          {% if hour >= 22 or hour < 6 %}
            mdi:weather-night
          {% elif hour >= 18 %}
            mdi:weather-sunset
          {% else %}
            mdi:weather-sunny
          {% endif %}
      
      # Bedtime window (based on school tomorrow)
      - name: "Bedtime Window Active"
        unique_id: bedtime_window_active
        state: >
          {% set hour = now().hour %}
          {% set school_tomorrow = is_state('input_boolean.school_tomorrow', 'on') %}
          {% set override = is_state('input_boolean.kids_bedtime_override', 'on') %}
          
          {% if override %}
            off
          {% elif school_tomorrow and hour >= 20 and hour < 22 %}
            on
          {% elif not school_tomorrow and hour >= 21 and hour < 23 %}
            on
          {% else %}
            off
          {% endif %}
        icon: mdi:bed-clock

  - binary_sensor:
      # School in session NOW (weekday + not holiday/closed + during school hours)
      - name: "School In Session Now"
        unique_id: school_in_session_now
        state: >
          {% set weekday = now().weekday() < 5 %}
          {% set hour = now().hour %}
          {% set school_hours = hour >= 8 and hour < 15 %}
          {{ weekday and school_hours and is_state('input_boolean.school_in_session_now', 'on') }}
        device_class: occupancy
      
      # Kids expected away (school in session + kids should be there)
      - name: "Kids Expected Away"
        unique_id: kids_expected_away
        state: >
          {{ is_state('binary_sensor.school_in_session_now', 'on') }}
        device_class: occupancy

# ═══════════════════════════════════════════════════════════
# SCRIPTS - Context Engines
# ═══════════════════════════════════════════════════════════

script:
  # ─────────────────────────────────────────────────────────
  # LIGHTING CONTEXT ENGINE
  # ─────────────────────────────────────────────────────────
  apply_lighting_context:
    alias: "Apply Lighting Context"
    icon: mdi:lightbulb-auto
    mode: single
    max_exceeded: silent
    sequence:
      - variables:
          occupancy: "{{ states('input_select.occupancy_mode') }}"
          time_ctx: "{{ states('sensor.time_context') }}"
          night_vision: "{{ is_state('input_boolean.preserve_night_vision', 'on') }}"
          bedtime: "{{ is_state('sensor.bedtime_window_active', 'on') }}"
          guest: "{{ is_state('input_boolean.guest_present', 'on') }}"
      
      # ── EMPTY HOUSE ──
      - if:
          - condition: template
            value_template: "{{ occupancy == 'Empty' }}"
        then:
          # All AL instances to sleep mode, minimal brightness
          - service: switch.turn_on
            target:
              entity_id:
                - switch.adaptive_lighting_sleep_mode_living_spaces
                - switch.adaptive_lighting_sleep_mode_kids_rooms
                - switch.adaptive_lighting_sleep_mode_entry_room_ceiling_lights
                - switch.adaptive_lighting_sleep_mode_upstairs_hallway
                - switch.adaptive_lighting_sleep_mode_kitchen_table
          # Optional: Turn off non-essential lights
          - service: light.turn_off
            target:
              entity_id:
                - light.living_room_tv_smart_light_strip
                - light.kitchen_lounge_ceiling_1of2
                - light.kitchen_lounge_ceiling_2of2
      
      # ── JOHN ONLY ──
      - if:
          - condition: template
            value_template: "{{ occupancy == 'John Only' }}"
        then:
          # Living spaces normal, rest minimal
          - service: switch.turn_off
            target:
              entity_id: switch.adaptive_lighting_sleep_mode_living_spaces
          - service: switch.turn_on
            target:
              entity_id:
                - switch.adaptive_lighting_sleep_mode_kids_rooms
                - switch.adaptive_lighting_sleep_mode_upstairs_hallway
          # Entry and kitchen based on time
          - if:
              - condition: template
                value_template: "{{ time_ctx in ['evening', 'night'] }}"
            then:
              - service: switch.turn_on
                target:
                  entity_id: switch.adaptive_lighting_sleep_mode_entry_room_ceiling_lights
            else:
              - service: switch.turn_off
                target:
                  entity_id: switch.adaptive_lighting_sleep_mode_entry_room_ceiling_lights
      
      # ── KIDS ONLY ──
      - if:
          - condition: template
            value_template: "{{ occupancy == 'Kids Only' }}"
        then:
          # Kids rooms active, living spaces minimal
          - service: switch.turn_off
            target:
              entity_id:
                - switch.adaptive_lighting_sleep_mode_kids_rooms
                - switch.adaptive_lighting_sleep_mode_upstairs_hallway
          - service: switch.turn_on
            target:
              entity_id:
                - switch.adaptive_lighting_sleep_mode_living_spaces
          # If bedtime window, enable sleep mode for kids areas
          - if:
              - condition: template
                value_template: "{{ bedtime }}"
            then:
              - service: switch.turn_on
                target:
                  entity_id:
                    - switch.adaptive_lighting_sleep_mode_kids_rooms
                    - switch.adaptive_lighting_sleep_mode_upstairs_hallway
      
      # ── JOHN + KIDS ──
      - if:
          - condition: template
            value_template: "{{ occupancy == 'John + Kids' }}"
        then:
          # All main areas active unless bedtime
          - if:
              - condition: template
                value_template: "{{ bedtime }}"
            then:
              # Bedtime: dim kids areas, normal living spaces
              - service: switch.turn_on
                target:
                  entity_id:
                    - switch.adaptive_lighting_sleep_mode_kids_rooms
                    - switch.adaptive_lighting_sleep_mode_upstairs_hallway
              - service: switch.turn_off
                target:
                  entity_id:
                    - switch.adaptive_lighting_sleep_mode_living_spaces
                    - switch.adaptive_lighting_sleep_mode_entry_room_ceiling_lights
            else:
              # Normal: all areas active
              - service: switch.turn_off
                target:
                  entity_id:
                    - switch.adaptive_lighting_sleep_mode_living_spaces
                    - switch.adaptive_lighting_sleep_mode_kids_rooms
                    - switch.adaptive_lighting_sleep_mode_entry_room_ceiling_lights
                    - switch.adaptive_lighting_sleep_mode_upstairs_hallway
                    - switch.adaptive_lighting_sleep_mode_kitchen_table
      
      # ── FULL HOUSE (John + Kids + Michelle) ──
      - if:
          - condition: template
            value_template: "{{ occupancy == 'Full House' }}"
        then:
          # All areas active, unless night
          - if:
              - condition: template
                value_template: "{{ time_ctx == 'night' }}"
            then:
              # Night mode for all
              - service: switch.turn_on
                target:
                  entity_id:
                    - switch.adaptive_lighting_sleep_mode_living_spaces
                    - switch.adaptive_lighting_sleep_mode_kids_rooms
                    - switch.adaptive_lighting_sleep_mode_entry_room_ceiling_lights
                    - switch.adaptive_lighting_sleep_mode_upstairs_hallway
                    - switch.adaptive_lighting_sleep_mode_kitchen_table
            else:
              # Daytime: all normal
              - service: switch.turn_off
                target:
                  entity_id:
                    - switch.adaptive_lighting_sleep_mode_living_spaces
                    - switch.adaptive_lighting_sleep_mode_kids_rooms
                    - switch.adaptive_lighting_sleep_mode_entry_room_ceiling_lights
                    - switch.adaptive_lighting_sleep_mode_upstairs_hallway
                    - switch.adaptive_lighting_sleep_mode_kitchen_table
      
      # ── GUEST PRESENT OVERLAY ──
      - if:
          - condition: template
            value_template: "{{ guest }}"
        then:
          # Ensure living spaces and entry are welcoming
          - service: switch.turn_off
            target:
              entity_id:
                - switch.adaptive_lighting_sleep_mode_living_spaces
                - switch.adaptive_lighting_sleep_mode_entry_room_ceiling_lights
      
      # ── PRESERVE NIGHT VISION OVERLAY ──
      - if:
          - condition: template
            value_template: "{{ night_vision }}"
        then:
          # Force all to sleep mode (deep red/dim)
          - service: switch.turn_on
            target:
              entity_id:
                - switch.adaptive_lighting_sleep_mode_living_spaces
                - switch.adaptive_lighting_sleep_mode_kids_rooms
                - switch.adaptive_lighting_sleep_mode_entry_room_ceiling_lights
                - switch.adaptive_lighting_sleep_mode_upstairs_hallway
                - switch.adaptive_lighting_sleep_mode_kitchen_table

  # ─────────────────────────────────────────────────────────
  # TABLET CONTEXT ENGINE
  # ─────────────────────────────────────────────────────────
  apply_tablet_context:
    alias: "Apply Tablet Context"
    icon: mdi:tablet-dashboard
    mode: single
    max_exceeded: silent
    sequence:
      - variables:
          occupancy: "{{ states('input_select.occupancy_mode') }}"
          kids_away: "{{ is_state('binary_sensor.kids_expected_away', 'on') }}"
          guest: "{{ is_state('input_boolean.guest_present', 'on') }}"
          base_url: "http://192.168.1.3:8123"
      
      # Determine dashboard URL
      - variables:
          dashboard_url: >
            {% if guest %}
              {{ base_url }}/lovelace/kitchen-guest
            {% elif occupancy == 'Empty' %}
              {{ base_url }}/lovelace/kitchen-away
            {% elif occupancy == 'John Only' %}
              {{ base_url }}/lovelace/kitchen-john
            {% elif occupancy == 'Kids Only' %}
              {{ base_url }}/lovelace/kitchen-kids
            {% else %}
              {{ base_url }}/lovelace/kitchen-family
            {% endif %}
      
      # Load URL on tablet
      - service: fully_kiosk.load_url
        data:
          entity_id: media_player.kitchen_wall_a9_tablet
          url: "{{ dashboard_url }}"
# ═══════════════════════════════════════════════════════════
# AUTOMATIONS - Core Triggers
# ═══════════════════════════════════════════════════════════

automation:
  # ─────────────────────────────────────────────────────────
  # OCCUPANCY MODE UPDATE (from presence system)
  # ─────────────────────────────────────────────────────────
  - id: update_occupancy_mode
    alias: "Occupancy → Update Mode"
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id:
          - input_boolean.john_home
          - input_boolean.alaina_home
          - input_boolean.ella_home
          - input_boolean.michelle_home
        for:
          seconds: 30  # Debounce
    action:
      - service: input_select.select_option
        target:
          entity_id: input_select.occupancy_mode
        data:
          option: "{{ states('sensor.occupancy_mode_auto') }}"
  
  # ─────────────────────────────────────────────────────────
  # CONTEXT APPLICATION TRIGGERS
  # ─────────────────────────────────────────────────────────
  - id: apply_context_on_occupancy_change
    alias: "Context → Apply on Occupancy Change"
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: input_select.occupancy_mode
    action:
      - service: script.apply_lighting_context
      - service: script.apply_tablet_context
  
  - id: apply_context_on_time_change
    alias: "Context → Apply on Time Change"
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: sensor.time_context
        for:
          seconds: 5
    action:
      - service: script.apply_lighting_context
  
  - id: apply_context_on_overlay_change
    alias: "Context → Apply on Overlay Change"
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id:
          - input_boolean.preserve_night_vision
          - input_boolean.guest_present
          - input_boolean.kids_bedtime_override
    action:
      - service: script.apply_lighting_context
  
  # ─────────────────────────────────────────────────────────
  # CALENDAR SNAPSHOT REFRESH
  # ─────────────────────────────────────────────────────────
  - id: refresh_school_tomorrow
    alias: "Calendar → Refresh School Tomorrow"
    mode: single
    max_exceeded: silent
    trigger:
      - platform: time
        at: "17:00:00"  # Daily refresh
      - platform: homeassistant
        event: start
    action:
      - service: calendar.get_events
        data:
          start_date_time: >
            {{ (now() + timedelta(days=1)).strftime('%Y-%m-%d 00:00:00') }}
          end_date_time: >
            {{ (now() + timedelta(days=1)).strftime('%Y-%m-%d 23:59:59') }}
        target:
          entity_id: calendar.master_calendar
        response_variable: tomorrow_events
      
      - variables:
          has_no_school: >
            {{ tomorrow_events['calendar.master_calendar'].events
               | selectattr('summary', 'search', '(?i)(no school|school closed|holiday|inservice|break)')
               | list | length > 0 }}
          is_weekend: >
            {{ (now() + timedelta(days=1)).weekday() >= 5 }}
      
      - service: input_boolean.turn_{{ 'off' if (has_no_school or is_weekend) else 'on' }}
        target:
          entity_id: input_boolean.school_tomorrow
  
  - id: refresh_school_in_session_now
    alias: "Calendar → Refresh School In Session Now"
    mode: single
    max_exceeded: silent
    trigger:
      - platform: time_pattern
        hours: "/1"  # Hourly check
    action:
      - service: calendar.get_events
        data:
          start_date_time: >
            {{ now().strftime('%Y-%m-%d 00:00:00') }}
          end_date_time: >
            {{ now().strftime('%Y-%m-%d 23:59:59') }}
        target:
          entity_id: calendar.master_calendar
        response_variable: today_events
      
      - variables:
          has_no_school: >
            {{ today_events['calendar.master_calendar'].events
               | selectattr('summary', 'search', '(?i)(no school|school closed|holiday|inservice|break)')
               | list | length > 0 }}
          is_weekend: >
            {{ now().weekday() >= 5 }}
      
      - service: input_boolean.turn_{{ 'off' if (has_no_school or is_weekend) else 'on' }}
        target:
          entity_id: input_boolean.school_in_session_now
  
  # ─────────────────────────────────────────────────────────
  # NIGHT PATH LIGHTING (Motion-based)
  # ─────────────────────────────────────────────────────────
  # ─────────────────────────────────────────────────────────
  # UPSTAIRS HALLWAY - Motion-Activated Lighting
  # Single automation handles all time contexts
  # ─────────────────────────────────────────────────────────
  - id: upstairs_hallway_motion_lighting
    alias: "Upstairs Hallway → Motion Lighting"
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.upstairs_hallway_motion
        to: "on"
    condition:
      - condition: state
        entity_id: light.upstairs_hallway
        state: "off"
    action:
      - choose:
          # NIGHT - Deep red, minimal brightness
          - conditions:
              - condition: state
                entity_id: sensor.time_context
                state: "night"
            sequence:
              - service: light.turn_on
                target:
                  entity_id: light.upstairs_hallway
                data:
                  brightness_pct: 3
                  rgb_color: [255, 20, 0]
              - wait_for_trigger:
                  - platform: state
                    entity_id: binary_sensor.upstairs_hallway_motion
                    to: "off"
                    for:
                      minutes: 2
                timeout:
                  minutes: 10
              - service: light.turn_off
                target:
                  entity_id: light.upstairs_hallway
                data:
                  transition: 3
        # DEFAULT (morning/day/evening) - Let adaptive lighting handle it
        default:
          - service: light.turn_on
            target:
              entity_id: light.upstairs_hallway
          - service: switch.turn_off
            target:
              entity_id: switch.adaptive_lighting_sleep_mode_upstairs_hallway
          - wait_for_trigger:
              - platform: state
                entity_id: binary_sensor.upstairs_hallway_motion
                to: "off"
                for:
                  minutes: 3
            timeout:
              minutes: 15
          - service: light.turn_off
            target:
              entity_id: light.upstairs_hallway
            data:
              transition: 5

  # ─────────────────────────────────────────────────────────
  # 2ND FLOOR BATHROOM - Night Path Lighting
  # Triggered by hallway P1 (mounted above bathroom door)
  # Night only - day is manual operation with adaptive lighting
  # ─────────────────────────────────────────────────────────
  - id: 2nd_floor_bathroom_night_lighting
    alias: "2nd Floor Bathroom → Night Lighting"
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.upstairs_hallway_motion
        to: "on"
    condition:
      - condition: state
        entity_id: sensor.time_context
        state: "night"
      - condition: state
        entity_id: light.2nd_floor_bathroom
        state: "off"
    action:
      - service: light.turn_on
        target:
          entity_id: light.2nd_floor_bathroom
        data:
          brightness_pct: 3
          rgb_color: [255, 20, 0]
      # Shower-safe: wait for extended clear period
      # Someone exiting bathroom MUST pass hallway P1
      - wait_for_trigger:
          - platform: state
            entity_id: binary_sensor.upstairs_hallway_motion
            to: "off"
            for:
              minutes: 10
        timeout:
          minutes: 45
      # Extra grace period after hallway clears
      - delay:
          minutes: 5
      # Gentle fade out
      - service: light.turn_off
        target:
          entity_id: light.2nd_floor_bathroom
        data:
          transition: 10

  - id: morning_wake_master_bedroom
    alias: "Morning Wake → Master Bedroom"
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.john_sleeping
        from: "on"
        to: "off"
    condition:
      - condition: time
        after: "05:30:00"
        before: "09:00:00"
      - condition: state
        entity_id: input_boolean.john_home
        state: "on"
    action:
      - service: light.turn_on
        target:
          entity_id: light.master_bedroom
        data:
          brightness_pct: 15
          kelvin: 2200
          transition: 5
      # Gradually brighten over 2 minutes
      - delay:
          seconds: 30
      - service: light.turn_on
        target:
          entity_id: light.master_bedroom
        data:
          brightness_pct: 30
          kelvin: 2500
          transition: 10
      # Prep upstairs bathroom - soft light ready for when John walks in
      - service: light.turn_on
        target:
          entity_id: light.2nd_floor_bathroom
        data:
          brightness_pct: 10
          kelvin: 2200
      # Turn off bathroom after 10 min if no motion (he went downstairs)
      - delay:
          minutes: 10
      - if:
          - condition: state
            entity_id: binary_sensor.upstairs_bathroom_motion
            state: "off"
            for:
              minutes: 5
        then:
          - service: light.turn_off
            target:
              entity_id: light.2nd_floor_bathroom
            data:
              transition: 5

# ═══════════════════════════════════════════════════════════
# Presence Display - Uses AP-Based Location Sensors
# Sources: ap_presence_hybrid.yaml sensors
# ═══════════════════════════════════════════════════════════

template:
  - sensor:
      # ─────────────────────────────────────────────────────
      # JOHN - Uses AP location (has floor built in)
      # ─────────────────────────────────────────────────────
      - name: "John Status"
        unique_id: john_status_display
        icon: >
          {% set loc = states('sensor.john_ap_location') %}
          {% if 'Home' in loc %}mdi:home-account
          {% elif loc == 'Away' %}mdi:car
          {% else %}mdi:map-marker
          {% endif %}
        state: "{{ states('sensor.john_ap_location') }}"

      # ─────────────────────────────────────────────────────
      # ALAINA - Uses AP location with school/mom fallback
      # ─────────────────────────────────────────────────────
      - name: "Alaina Status"
        unique_id: alaina_status_display
        icon: >
          {% set loc = states('sensor.alaina_ap_location') %}
          {% if 'Home' in loc %}mdi:home-account
          {% elif loc == 'School' or 'School' in states('person.alaina_spencer') %}mdi:school
          {% elif loc == 'Away' %}mdi:car
          {% else %}mdi:map-marker
          {% endif %}
        state: >
          {% set ap = states('sensor.alaina_ap_location') %}
          {% set person = states('person.alaina_spencer') %}
          {% if ap not in ['unavailable', 'unknown', ''] and ap != 'Away' %}
            {{ ap }}
          {% elif 'School' in person or 'Whitehall' in person %}
            School
          {% elif "Traci" in person or is_state_attr('sensor.alaina_ap_location', 'at_moms', true) %}
            At Mom's
          {% elif person == 'home' or is_state('input_boolean.alaina_home', 'on') %}
            Home
          {% else %}
            Away
          {% endif %}

      # ─────────────────────────────────────────────────────
      # ELLA - Uses AP location with school/mom fallback
      # ─────────────────────────────────────────────────────
      - name: "Ella Status"
        unique_id: ella_status_display
        icon: >
          {% set loc = states('sensor.ella_ap_location') %}
          {% if 'Home' in loc %}mdi:home-account
          {% elif loc == 'School' or 'School' in states('person.ella_spencer') %}mdi:school
          {% elif loc == 'Away' %}mdi:car
          {% else %}mdi:map-marker
          {% endif %}
        state: >
          {% set ap = states('sensor.ella_ap_location') %}
          {% set person = states('person.ella_spencer') %}
          {% if ap not in ['unavailable', 'unknown', ''] and ap != 'Away' %}
            {{ ap }}
          {% elif 'School' in person or 'Whitehall' in person %}
            School
          {% elif "Traci" in person or is_state_attr('sensor.ella_ap_location', 'at_moms', true) %}
            At Mom's
          {% elif person == 'home' or is_state('input_boolean.ella_home', 'on') %}
            Home
          {% else %}
            Away
          {% endif %}

      # ─────────────────────────────────────────────────────
      # MICHELLE - Uses AP location
      # ─────────────────────────────────────────────────────
      - name: "Michelle Status"
        unique_id: michelle_status_display
        icon: >
          {% set loc = states('sensor.michelle_ap_location') %}
          {% if "John's House" in loc %}mdi:home-account
          {% elif loc == 'Her House' %}mdi:home-heart
          {% elif loc == 'Away' %}mdi:car
          {% else %}mdi:map-marker
          {% endif %}
        state: "{{ states('sensor.michelle_ap_location') }}"

      # ─────────────────────────────────────────────────────
      # HOUSE SUMMARY - Who's home using AP data
      # ─────────────────────────────────────────────────────
      - name: "House Summary"
        unique_id: house_summary_display
        icon: mdi:home-group
        state: >
          {% set john = 'Home' in states('sensor.john_ap_location') %}
          {% set alaina = 'Home' in states('sensor.alaina_ap_location') or is_state('input_boolean.alaina_home', 'on') %}
          {% set ella = 'Home' in states('sensor.ella_ap_location') or is_state('input_boolean.ella_home', 'on') %}
          {% set michelle = "John's House" in states('sensor.michelle_ap_location') %}
          {% set count = [john, alaina, ella, michelle] | select('true') | list | length %}
          {% if count == 0 %}Empty
          {% elif count == 1 %}
            {% if john %}John Only{% elif alaina %}Alaina Only{% elif ella %}Ella Only{% else %}Michelle Only{% endif %}
          {% elif count == 4 %}Full House
          {% else %}{{ count }} People Home{% endif %}
        attributes:
          who_home: >
            {% set p = [] %}
            {% if 'Home' in states('sensor.john_ap_location') %}{% set p = p + ['John'] %}{% endif %}
            {% if 'Home' in states('sensor.alaina_ap_location') or is_state('input_boolean.alaina_home', 'on') %}{% set p = p + ['Alaina'] %}{% endif %}
            {% if 'Home' in states('sensor.ella_ap_location') or is_state('input_boolean.ella_home', 'on') %}{% set p = p + ['Ella'] %}{% endif %}
            {% if "John's House" in states('sensor.michelle_ap_location') %}{% set p = p + ['Michelle'] %}{% endif %}
            {{ p | join(', ') if p else 'Nobody' }}
